<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Changemaker Spark Planner (Live)</title>
            <style>
        .loader {
            display: none;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 2s linear infinite;
            margin-left: 10px;
        }
        .panel.loading .loader { display: block; }
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .panel.processing {
            border: 1px solid #4285F4;
            box-shadow: 0 0 5px rgba(66, 133, 244, 0.5);
        }
        .input-container {
            background-color: #e9eef6;
            border: 1px solid #d0d7e5;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .input-container .panel {
            background-color: #ffffff;
        }
        .input-row {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .input-row .panel {
            flex: 1;
        }
        #planner .panel textarea {
            min-height: 300px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; }
        h1, h2 { text-align: center; }
        .container { display: flex; flex-direction: column; gap: 20px; }
        .panel { background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .panel-title { font-size: 1.2em; font-weight: bold; }
        textarea { width: 100%; min-height: 150px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-family: inherit; font-size: 1em; resize: vertical; }
        button { background-color: #4285F4; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background-color: #357ae8; }
        .initial-inputs { display: flex; gap: 20px; margin-bottom: 20px; }
        .initial-inputs input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    .markdown-view {
            display: none;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
            text-align: left;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 10px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .switch span {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .switch span:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + span {
            background-color: #2196F3;
        }
        input:checked + span:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>

    <h1>Gemini Changemaker Spark Planner (Live)</h1>

    <div class="initial-inputs">
        <input type="password" id="apiKey" placeholder="Enter your Gemini API Key">
        <button onclick="saveApiKey()">Save Key</button>
    </div>

    <div class="input-container">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Number of Classes</div>
            </div>
            <input type="number" id="numSessions" value="20">
        </div>
        <div class="input-row">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Project Context</div>
                </div>
                <textarea id="projectContext">We have 20 classes for a unit on the lifecycle of a product. This is in the context of SDG on responsible consumption. We want students to investigate the full lifecycle of products from gathering raw materials, refining raw materials into usable inputs for manufacturing, manufacturing products, production and distribution, and product life cycle. All along the way, we want students to get an understanding of the people involved at each stage of the process for the empathy stage. Each student will choose one perspective from the lifecycle to do research, understand and make claims about, and then produce the product.  </textarea>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Final Product</div>
                </div>
                <textarea id="finalProduct">There are two components to the final product. One consists of an artistic collage made in Photoshop that integrates principles of design, color, and composition. The interactive graphic will have hotspots that when a mouse hovers over them, information coming from research the students gathered about their specific perspective will appear. 

The proposed sequences is that students will review CRAAP test and source evaluation, and then do research as an assessment for adaptive thinking, and will gather AI generated summaries of different articles that they find interesting. Then they collect facts and information about their perspective to create a message that uses that information in a planning document. This document then forms the basis for brainstorming content for the collage. Students do not have experience in photoshop, so they will learn the skills first in a mini project (short design cycle about creating a hybrid animal from different images found online) and then for the actual collage.

Then with the completed collage, they will learn to use the interactive graphic software (called Genially) to build their interactive graphic. In the end, students will do brief presentations of their graphics to classmates. We want them first to present to peers, and then present in front of the class.</textarea>
            </div>
        </div>
    </div>

    <div id="planner" class="container">

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Timeline</div>
                <div class="loader" id="timeline-loader"></div>
                <div class="switch-container">
                    <span class="switch-label">Edit Mode</span>
                    <label class="switch"><input type="checkbox" onchange="toggleView(this, 'timeline')"><span></span></label>
                </div>
                <button onclick="copyContent('timeline')">Copy</button>
                <button onclick="runAgents('timeline')">Generate</button>
            </div>
            <div class="markdown-view" id="timeline-view"></div>
            <textarea id="timeline-output"></textarea>
        </div>
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Design Cycle Activities</div>
                <div class="loader" id="design-loader"></div>
                <div class="switch-container">
                    <span class="switch-label">Edit Mode</span>
                    <label class="switch"><input type="checkbox" onchange="toggleView(this, 'design')"><span></span></label>
                </div>
                <button onclick="copyContent('design')">Copy</button>
                <button onclick="runAgents('design')">Generate</button>
            </div>
            <div class="markdown-view" id="design-view"></div>
            <textarea id="design-output"></textarea>
        </div>
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Assessments</div>
                <div class="loader" id="assessment-loader"></div>
                <div class="switch-container">
                    <span class="switch-label">Edit Mode</span>
                    <label class="switch"><input type="checkbox" onchange="toggleView(this, 'assessment')"><span></span></label>
                </div>
                <button onclick="copyContent('assessment')">Copy</button>
                <button onclick="runAgents('assessment')">Generate</button>
            </div>
            <div class="markdown-view" id="assessment-view"></div>
            <textarea id="assessment-output"></textarea>
        </div>
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Unit Plan</div>
                <div class="loader" id="unit-plan-loader"></div>
                <div class="switch-container">
                    <span class="switch-label">Edit Mode</span>
                    <label class="switch"><input type="checkbox" onchange="toggleView(this, 'unit-plan')"><span></span></label>
                </div>
                <button onclick="copyContent('unit-plan')">Copy</button>
                <button onclick="runAgents('unit')">Generate</button>
            </div>
            <div class="markdown-view" id="unit-plan-view"></div>
            <textarea id="unit-plan-output"></textarea>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="changemaker_proficiency_scales.js"></script>
    <script src="geminiAgentFramework.js"></script>
    <script src="gemini.js"></script>
    <script>
        const TIMELINE_PROMPT = `You are TimelineAgent. You receive an input with:
- A project context (brief description)
- Desired final product
- Number of class sessions (e.g., 5)

Produce a Markdown list outlining each day/session:
Day 1: …
Day 2: …
...
Use the context and final product deadline to sequence: introduction, design phases, build, reflection. Think about the time required to instruct a class of tenth graders any new skills they might need, process new information or knowledge, and complete independent tasks. This may also dictate the depth of tasks that might be possible.
Return only the Markdown outline.`;

        const DESIGN_PROMPT = `You are DesignCycleAgent. You receive:
- Project context (same as TimelineAgent)
- Number of class sessions
- Timeline outline (Markdown with Day 1–Day N)
- A menu of potential design-cycle activities based on the design cycle. These may include:
  Empathy: Knowledge Audit, Empathy Map, Empathy Walks, Survey, Interviews
  Define: SDG Alignment, Preliminary Research, Academic Research, Problem Statement, Perspective Mapping, Root Cause Analysis, Iceberg Analysis
  Ideate: Individual Brainstorm, Mind Map, How-Now-Wow, AI Partner Brainstorm, Bad Ideas Only Brainstorm, Spend a Nickel, Feasibility / Impact Matrix
  Prototype: Practical Considerations, Success Criteria, Build a Solution, Pre-Mortem
  Test/Reflect: Expert in the Field Feedback, Written Reflection, Stakeholder Feedback

For each day in the timeline, suggest 1–2 specific activities adapted to this project. Include brief instructions.
Return only Markdown with headings Day 1–Day N and bullet activities.`;

        const ASSESS_PROMPT = `You are AssessmentAgent, an expert in five Changemakers proficiency scales.
You receive:
- Project context
- Number of class sessions
- Timeline outline
- Design-cycle activities per day

For each day, propose:
- One L1.5 assessment activity connected to one proficiency scale
- One L2 assessment example (foundational knowledge) for a different scale
- Optionally, an L3 assessment if it fits (extended, longer tasks)
Make sure activities align to the given proficiencies. Reference the scale name.
Return only Markdown with headings Day 1–Day N.`;

        const PLAN_PROMPT = `You are UnitPlannerAgent. You receive:
- Project context and final product description
- Number of class sessions
- Timeline outline (Markdown)
- Design-cycle activities (Markdown)
- Assessment suggestions (Markdown)

Combine all inputs into a cohesive unit plan in Markdown for clear formatting. You can feel free to override individual elements from other agents for the purpose of a coherent and high quality unit plan that combines the best ideas from each.  

Begin with a Markdown Table showing the pacing for the full unit.

Then output a day-by-day outline that includes:
1. Design-cycle activities
2. Assessment(s) with proficiency references
3. Sequence of driving questions for segment of the lesson
4. Time allocations for each activity and stage of the lesson (80-minute block)

Return only that text.`;

        function toggleView(checkbox, name) {
            const view = document.getElementById(`${name}-view`);
            const edit = document.getElementById(`${name}-output`);
            const label = checkbox.parentElement.previousElementSibling;
            if (checkbox.checked) {
                view.innerHTML = marked.parse(edit.value);
                view.style.display = 'block';
                edit.style.display = 'none';
                label.textContent = 'Markdown';
            } else {
                view.style.display = 'none';
                edit.style.display = 'block';
                label.textContent = 'Edit Mode';
            }
        }

        function copyContent(name) {
            const content = document.getElementById(`${name}-output`).value;
            navigator.clipboard.writeText(content).then(() => {
                alert('Copied to clipboard!');
            });
        }

        function showLoader(name) { 
            const panel = document.getElementById(`${name}-loader`).closest('.panel');
            panel.classList.add('loading');
            panel.classList.add('processing');
        }
        function hideLoader(name) { 
            const panel = document.getElementById(`${name}-loader`).closest('.panel');
            panel.classList.remove('loading');
            panel.classList.remove('processing');
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                alert('API Key saved.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
        });

        const agentManager = new SimpleAgentManager();

        // Define Agent Behaviors
        const timelineBehavior = async (message, memory) => {
            showLoader('timeline');
            const { projectContext, finalProduct, numSessions } = message.content;
            const prompt = TIMELINE_PROMPT
                .replace('A project context (brief description)', `"${projectContext}"`)
                .replace('Desired final product', `"${finalProduct}"`)
                .replace('Number of class sessions (e.g., 5)', `${numSessions}`);
            
            const output = await runGemini(prompt);
            document.getElementById('timeline-output').value = output;
            hideLoader('timeline');
            return { to: 'DesignCycleAgent', content: { ...message.content, timeline: output } };
        };

        const designBehavior = async (message, memory) => {
            showLoader('design');
            const { projectContext, numSessions, timeline } = message.content;
            const prompt = DESIGN_PROMPT
                .replace('Project context (same as TimelineAgent)', `"${projectContext}"`)
                .replace('Number of class sessions', numSessions)
                .replace('Timeline outline (Markdown with Day 1–Day N)', `the following timeline:\n${timeline}`);

            const output = await runGemini(prompt);
            document.getElementById('design-output').value = output;
            hideLoader('design');
            return { to: 'AssessmentAgent', content: { ...message.content, designActivities: output } };
        };

        const assessmentBehavior = async (message, memory) => {
            showLoader('assessment');
            const { projectContext, numSessions, timeline, designActivities } = message.content;
            const prompt = `${ASSESS_PROMPT
                .replace('Project context', `"${projectContext}"`)
                .replace('Number of class sessions', numSessions)
                .replace('Timeline outline', `the following timeline:\n${timeline}`)
                .replace('Design-cycle activities per day', `the following design activities:\n${designActivities}`)}

Here are the proficiency scales to use:
${PROFICIENCY_SCALES}`;

            const output = await runGemini(prompt);
            document.getElementById('assessment-output').value = output;
            hideLoader('assessment');
            return { to: 'UnitPlannerAgent', content: { ...message.content, assessments: output } };
        };

        const unitPlannerBehavior = async (message, memory) => {
            showLoader('unit-plan');
            const { projectContext, finalProduct, numSessions, timeline, designActivities, assessments } = message.content;
            const prompt = PLAN_PROMPT
                .replace('Project context and final product description', `Project Context: "${projectContext}"\nFinal Product: "${finalProduct}"`)
                .replace('Number of class sessions', numSessions)
                .replace('Timeline outline (Markdown)', `the following timeline:\n${timeline}`)
                .replace('Design-cycle activities (Markdown)', `the following design activities:\n${designActivities}`)
                .replace('Assessment suggestions (Markdown)', `the following assessments:\n${assessments}`);

            const output = await runGemini(prompt);
            document.getElementById('unit-plan-output').value = output;
            hideLoader('unit-plan');
            // End of the chain
        };

        // Register Agents
        agentManager.register(new Agent('TimelineAgent', timelineBehavior));
        agentManager.register(new Agent('DesignCycleAgent', designBehavior));
        agentManager.register(new Agent('AssessmentAgent', assessmentBehavior));
        agentManager.register(new Agent('UnitPlannerAgent', unitPlannerBehavior));

        function runAgents(startFrom) {
            const projectContext = document.getElementById('projectContext').value;
            const finalProduct = document.getElementById('finalProduct').value;
            const numSessions = document.getElementById('numSessions').value;

            if (!projectContext || !finalProduct || !numSessions) {
                alert('Please fill in all initial inputs.');
                return;
            }

            const initialContent = { projectContext, finalProduct, numSessions };
            let startAgent;

            switch(startFrom) {
                case 'timeline':
                    startAgent = 'TimelineAgent';
                    break;
                case 'design':
                    startAgent = 'DesignCycleAgent';
                    initialContent.timeline = document.getElementById('timeline-output').value;
                    break;
                case 'assessment':
                    startAgent = 'AssessmentAgent';
                    initialContent.timeline = document.getElementById('timeline-output').value;
                    initialContent.designActivities = document.getElementById('design-output').value;
                    break;
                case 'unit':
                    startAgent = 'UnitPlannerAgent';
                    initialContent.timeline = document.getElementById('timeline-output').value;
                    initialContent.designActivities = document.getElementById('design-output').value;
                    initialContent.assessments = document.getElementById('assessment-output').value;
                    break;
            }

            agentManager.startConversation('user', startAgent, initialContent);
        }
    </script>
</body>
</html>