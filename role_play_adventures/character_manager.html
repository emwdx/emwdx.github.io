<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Adventure Character Manager</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  :root { --accent: #e11d48; --ink: #0f172a; }
  body { background: #f4f4f5; font-family: "Inter", system-ui, -apple-system, sans-serif; color: var(--ink); }
  .shell { max-width: 1100px; margin: 20px auto 32px; background: #fff; border-radius: 18px; box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08); }
  .shell-header { padding: 18px 24px 12px; border-bottom: 1px solid #e5e7eb; }
  .shell-body { padding: 20px 24px 28px; }
  h1 { font-weight: 800; letter-spacing: .02em; }
  label { font-weight: 700; }
  input, textarea { font-size: 1.05rem !important; }
  textarea { min-height: 80px; }
  .nav-pills .nav-link.active { background: var(--accent); }
  .circle, .square {
    width: 26px; height: 26px; border-radius: 50%; border: 2px solid #cbd5e1;
    display: inline-flex; align-items: center; justify-content: center;
    margin-right: 6px; cursor: pointer; transition: all .15s; background: #fff; font-size: 18px; user-select: none;
  }
  .square { border-radius: 6px; margin-right: 10px; }
  .filled { background: var(--accent); border-color: var(--accent); color: #fff; box-shadow: 0 6px 16px rgba(225, 29, 72, 0.28); }
  .counter { font-weight: 800; color: var(--accent); }
  .inventory-item { display: flex; align-items: center; margin-bottom: 10px; }
  .shake { animation: wiggle .25s; }
  @keyframes wiggle { 0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)} }
  .card-name { font-weight: 800; }
  .badge-light { background: #f8fafc; color: #334155; }
</style>
</head>
<body>
  <div class="shell">
    <div class="shell-header d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <h1 class="mb-0">Adventure Character Manager</h1>
        <div class="text-muted small">Local-only storage. Use export to save a file.</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-dark" id="exportJson">Export JSON</button>
        <button class="btn btn-outline-secondary" id="importJson">Import JSON</button>
        <button class="btn btn-success" id="addNewBtn">New Character</button>
      </div>
    </div>
    <div class="shell-body">
      <ul class="nav nav-pills mb-3" id="tabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#addTab">Add / Edit</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#browseTab">Browse</button></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="addTab">
          <form id="charForm" class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Name and age</label>
              <input class="form-control" id="nameAge" required placeholder="e.g., Sunflare the Dragon, age 8">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Creature Type</label>
              <input class="form-control" id="creatureType" placeholder="dragon, chicken, wolf, snake, etc.">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Role</label>
              <input class="form-control" id="role" placeholder="knight, healer, scout, wizard, trickster, etc.">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Three words that describe you</label>
              <textarea class="form-control" id="personalityWords"></textarea>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">What makes you brave?</label>
              <textarea class="form-control" id="brave"></textarea>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Something silly or funny about you</label>
              <textarea class="form-control" id="funny"></textarea>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Where is your hero from?</label>
              <textarea class="form-control" id="from"></textarea>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">What does your hero want most?</label>
              <textarea class="form-control" id="want"></textarea>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">What is your hero afraid of, and why?</label>
              <textarea class="form-control" id="afraid"></textarea>
            </div>

            <div class="col-12">
              <div class="d-flex align-items-center gap-2">
                <h5 class="mb-0">Skill Points</h5><span class="counter" id="skillCount">0/20</span>
              </div>
              <div class="text-muted small mb-1">Tap circles to assign up to 20 total points (max 6 per skill).</div>
              <div class="table-responsive">
                <table class="table table-borderless align-middle mb-0">
                  <thead><tr><th>Skill</th><th>Points</th></tr></thead>
                  <tbody id="skillsTable"></tbody>
                </table>
              </div>
            </div>

            <div class="col-12">
              <div class="d-flex align-items-center gap-2">
                <h5 class="mb-0">Inventory</h5><span class="counter" id="inventoryCount">0/6</span>
              </div>
              <div class="text-muted small mb-1">Pick up to 6 items.</div>
              <div class="row" id="inventoryGrid"></div>
            </div>

            <div class="col-12 d-flex gap-2">
              <button class="btn btn-primary" type="submit" id="saveBtn">Save Character</button>
              <button class="btn btn-outline-secondary" type="button" id="resetBtn">Clear Form</button>
            </div>
          </form>
        </div>

        <div class="tab-pane fade" id="browseTab">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Saved Characters</h5>
            <small class="text-muted" id="countLabel"></small>
          </div>
          <div id="charList" class="row g-3"></div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const skillDefinitions = [
    { id: 0, name: 'Strength',   description: 'Lifting, fighting, pushing' },
    { id: 1, name: 'Speed',      description: 'Running, dodging' },
    { id: 2, name: 'Magic',      description: 'Spells, cool powers' },
    { id: 3, name: 'Cleverness', description: 'Puzzles, tricks' },
    { id: 4, name: 'Kindness',   description: 'Helping friends, calming creatures' }
  ];
  const inventoryDefinitions = [
    { id: 0,  name: 'Sword',             description: 'A sharp blade for close combat.' },
    { id: 1,  name: 'Shield',            description: 'Blocks attacks and protects allies.' },
    { id: 2,  name: 'Stink Bomb',        description: 'A smelly distraction bomb.' },
    { id: 3,  name: 'Rope',              description: 'For climbing, tying, or rescuing.' },
    { id: 4,  name: 'Lantern',           description: 'Lights dark caves and tunnels.' },
    { id: 5,  name: 'Feathered Cloak',   description: 'Lightweight cloak that improves agility.' },
    { id: 6,  name: 'Healing Potion',    description: 'Restores health or energy.' },
    { id: 7,  name: 'Map',               description: 'Shows hidden paths and landmarks.' },
    { id: 8,  name: 'Feather',           description: 'A light magical feather.' },
    { id: 9,  name: 'Golden Coin',       description: 'Valuable currency for trading.' },
    { id: 10, name: 'Magic Scroll',      description: 'Contains a single-use spell.' },
    { id: 11, name: 'Crystal Ball',      description: 'Reveals clues or visions.' },
    { id: 12, name: 'Mystic Amulet',     description: 'Protective charm with hidden power.' },
    { id: 13, name: 'Whispering Stone',  description: 'Lets you communicate over short distances.' },
    { id: 14, name: 'Ancient Tome',      description: 'Old book full of forgotten knowledge.' },
    { id: 15, name: 'Wind-Song Flute',   description: 'Controls breezes or calms creatures.' },
    { id: 16, name: 'Enchanted Compass', description: 'Points toward your goal or danger.' },
    { id: 17, name: 'Dragon Scale',      description: 'Extremely tough; useful for defense or crafting.' },
    { id: 18, name: 'Silver Coin',       description: 'Common currency with minor magical glint.' },
    { id: 19, name: 'Banana Peel',       description: 'Surprisingly slippery; great for comedy traps.' }
  ];
  const maxSkillPoints = 20;
  const maxInventory = 6;
  const storageKey = 'nora_characters_v1';
  let editingId = null;

  function genId() {
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    const arr = (window.crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint8Array(16)) : null;
    if (arr) return Array.from(arr, b => b.toString(16).padStart(2, '0')).join('');
    return 'id-' + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function loadCharacters() {
    try {
      return JSON.parse(localStorage.getItem(storageKey)) || [];
    } catch {
      return [];
    }
  }
  function saveCharacters(list) {
    localStorage.setItem(storageKey, JSON.stringify(list));
  }

  function sanitizeCharacter(raw) {
    if (!raw) return null;
    const baseSkills = Array.isArray(raw.skills) ? raw.skills : (Array.isArray(raw.skillDetails) ? raw.skillDetails.map(s => s?.points ?? 0) : []);
    const skills = baseSkills.slice(0, skillDefinitions.length).map(v => {
      const num = Number(v) || 0;
      return Math.max(0, Math.min(6, num));
    });
    while (skills.length < skillDefinitions.length) skills.push(0);
    const inventory = Array.isArray(raw.inventory)
      ? raw.inventory.map(Number).filter(Number.isInteger)
      : (Array.isArray(raw.inventoryDetails) ? raw.inventoryDetails.map(d => Number(d?.id)).filter(Number.isInteger) : []);
    return {
      id: raw.id || genId(),
      nameAge: raw.nameAge || '',
      creatureType: raw.creatureType || '',
      role: raw.role || '',
      personalityWords: raw.personalityWords || '',
      brave: raw.brave || '',
      funny: raw.funny || '',
      from: raw.from || '',
      want: raw.want || '',
      afraid: raw.afraid || '',
      skills,
      inventory,
      updatedAt: raw.updatedAt || new Date().toISOString()
    };
  }

  function buildExportPayload(characters) {
    return {
      version: 2,
      exportedAt: new Date().toISOString(),
      skills: skillDefinitions,
      items: inventoryDefinitions,
      characters: characters.map(char => ({
        ...char,
        skillDetails: skillDefinitions.map((skill, idx) => ({
          ...skill,
          points: (char.skills || [])[idx] || 0
        })),
        inventoryDetails: (char.inventory || []).map(idx => {
          const def = inventoryDefinitions[idx];
          return def ? { ...def } : null;
        }).filter(Boolean)
      }))
    };
  }

  function createSkills() {
    const tbody = document.getElementById('skillsTable');
    tbody.innerHTML = '';
    skillDefinitions.forEach((skill, skillIndex) => {
      const tr = document.createElement('tr');
      const nameTd = document.createElement('td');
      nameTd.innerHTML = '<div class="fw-bold">' + skill.name + '</div><div class="text-muted small">' + skill.description + '</div>';
      const circlesTd = document.createElement('td');
      for (let i = 0; i < 6; i++) {
        const c = document.createElement('div');
        c.className = 'circle';
        c.dataset.skill = skillIndex;
        c.dataset.index = i;
        c.addEventListener('click', toggleCircle);
        circlesTd.appendChild(c);
      }
      tr.appendChild(nameTd);
      tr.appendChild(circlesTd);
      tbody.appendChild(tr);
    });
    updateSkillCounter();
  }

  function createInventory() {
    const grid = document.getElementById('inventoryGrid');
    grid.innerHTML = '';
    inventoryDefinitions.forEach((item, idx) => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6';
      const row = document.createElement('div');
      row.className = 'inventory-item';
      const box = document.createElement('div');
      box.className = 'square';
      box.dataset.item = idx;
      box.addEventListener('click', toggleInventory);
      const label = document.createElement('span');
      label.textContent = item.name;
      row.appendChild(box); row.appendChild(label);
      col.appendChild(row);
      grid.appendChild(col);
    });
    updateInventoryCounter();
  }

  function totalSkillSelected() { return document.querySelectorAll('.circle.filled').length; }
  function totalInventorySelected() { return document.querySelectorAll('.square.filled').length; }
  function updateSkillCounter() { document.getElementById('skillCount').textContent = totalSkillSelected() + '/' + maxSkillPoints; }
  function updateInventoryCounter() { document.getElementById('inventoryCount').textContent = totalInventorySelected() + '/' + maxInventory; }

  function toggleCircle(e) {
    const t = e.currentTarget;
    const filled = t.classList.contains('filled');
    if (!filled && totalSkillSelected() >= maxSkillPoints) { bump(t); return; }
    t.classList.toggle('filled');
    updateSkillCounter();
  }
  function toggleInventory(e) {
    const t = e.currentTarget;
    const filled = t.classList.contains('filled');
    if (!filled && totalInventorySelected() >= maxInventory) { bump(t); return; }
    t.classList.toggle('filled');
    updateInventoryCounter();
  }
  function bump(el) { el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'), 250); }

  function getSkillData() {
    const skillCounts = [];
    skillDefinitions.forEach((_, idx) => {
      const filled = document.querySelectorAll('.circle.filled[data-skill="'+idx+'"]').length;
      skillCounts.push(filled);
    });
    return skillCounts;
  }
  function setSkillData(counts) {
    document.querySelectorAll('.circle').forEach(c => c.classList.remove('filled'));
    counts.forEach((cnt, skillIdx) => {
      for (let i = 0; i < cnt && i < 6; i++) {
        const el = document.querySelector('.circle[data-skill="'+skillIdx+'"][data-index="'+i+'"]');
        if (el) el.classList.add('filled');
      }
    });
    updateSkillCounter();
  }

  function getInventoryData() {
    const picks = [];
    document.querySelectorAll('.square.filled').forEach(el => picks.push(parseInt(el.dataset.item, 10)));
    return picks;
  }
  function setInventoryData(picks) {
    document.querySelectorAll('.square').forEach(s => s.classList.remove('filled'));
    picks.forEach(idx => {
      const el = document.querySelector('.square[data-item="'+idx+'"]');
      if (el) el.classList.add('filled');
    });
    updateInventoryCounter();
  }

  function clearForm() {
    document.getElementById('charForm').reset();
    setSkillData(Array(skillDefinitions.length).fill(0));
    setInventoryData([]);
    editingId = null;
    document.getElementById('saveBtn').textContent = 'Save Character';
  }

  function collectForm() {
    return {
      id: editingId || genId(),
      nameAge: document.getElementById('nameAge').value.trim(),
      creatureType: document.getElementById('creatureType').value.trim(),
      role: document.getElementById('role').value.trim(),
      personalityWords: document.getElementById('personalityWords').value.trim(),
      brave: document.getElementById('brave').value.trim(),
      funny: document.getElementById('funny').value.trim(),
      from: document.getElementById('from').value.trim(),
      want: document.getElementById('want').value.trim(),
      afraid: document.getElementById('afraid').value.trim(),
      skills: getSkillData(),
      inventory: getInventoryData(),
      updatedAt: new Date().toISOString()
    };
  }

  function renderList() {
    const list = loadCharacters();
    const container = document.getElementById('charList');
    const label = document.getElementById('countLabel');
    label.textContent = list.length ? list.length + ' character(s)' : 'No characters yet.';
    container.innerHTML = '';
    list.forEach(char => {
      const col = document.createElement('div');
      col.className = 'col-12 col-md-6';
      const card = document.createElement('div');
      card.className = 'card h-100 shadow-sm';
      const body = document.createElement('div');
      body.className = 'card-body';
      const title = document.createElement('div');
      title.className = 'card-name';
      title.textContent = char.nameAge || 'Unnamed hero';
      const meta = document.createElement('div');
      meta.className = 'text-muted small mb-2';
      meta.textContent = (char.creatureType || 'Creature?') + ' â€¢ ' + (char.role || 'Role?');
      const skillsLine = document.createElement('div');
      skillsLine.className = 'small mb-2';
      const skillScores = Array.isArray(char.skills) ? char.skills : Array(skillDefinitions.length).fill(0);
      skillsLine.innerHTML = '<strong>Skills:</strong> ' + skillScores.map((v,i)=>{
        const skill = skillDefinitions[i];
        const label = skill ? skill.name : 'Skill ' + (i+1);
        return label + ': ' + v;
      }).join(', ');
      const itemsLine = document.createElement('div');
      itemsLine.className = 'small';
      const inventoryPicks = Array.isArray(char.inventory) ? char.inventory : [];
      const itemNames = inventoryPicks.map(idx => inventoryDefinitions[idx]?.name).filter(Boolean);
      itemsLine.innerHTML = '<strong>Items:</strong> ' + (itemNames.length ? itemNames.join(', ') : 'None');
      const btnRow = document.createElement('div');
      btnRow.className = 'd-flex gap-2 mt-3';
      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-sm btn-outline-primary';
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => loadForEdit(char.id);
      const delBtn = document.createElement('button');
      delBtn.className = 'btn btn-sm btn-outline-danger';
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => deleteChar(char.id);
      btnRow.append(editBtn, delBtn);
      body.append(title, meta, skillsLine, itemsLine, btnRow);
      card.appendChild(body);
      col.appendChild(card);
      container.appendChild(col);
    });
  }

  function loadForEdit(id) {
    const list = loadCharacters();
    const char = list.find(c => c.id === id);
    if (!char) return;
    editingId = id;
    document.getElementById('saveBtn').textContent = 'Save Changes';
    const fields = ['nameAge','creatureType','role','personalityWords','brave','funny','from','want','afraid'];
    fields.forEach(f => { const el = document.getElementById(f); if (el) el.value = char[f] || ''; });
    setSkillData(char.skills || Array(skillDefinitions.length).fill(0));
    setInventoryData(char.inventory || []);
    const tabTrigger = document.querySelector('[data-bs-target="#addTab"]');
    if (tabTrigger) new bootstrap.Tab(tabTrigger).show();
  }

  function deleteChar(id) {
    const list = loadCharacters().filter(c => c.id !== id);
    saveCharacters(list);
    if (editingId === id) clearForm();
    renderList();
  }

  document.getElementById('charForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const data = collectForm();
    if (!data.nameAge) return;
    const list = loadCharacters();
    const existingIdx = list.findIndex(c => c.id === data.id);
    if (existingIdx >= 0) list[existingIdx] = data; else list.push(data);
    saveCharacters(list);
    renderList();
    clearForm();
    const tabTrigger = document.querySelector('[data-bs-target="#browseTab"]');
    if (tabTrigger) new bootstrap.Tab(tabTrigger).show();
  });

  document.getElementById('resetBtn').addEventListener('click', clearForm);
  document.getElementById('addNewBtn').addEventListener('click', () => {
    clearForm();
    const tabTrigger = document.querySelector('[data-bs-target="#addTab"]');
    if (tabTrigger) new bootstrap.Tab(tabTrigger).show();
  });

  document.getElementById('exportJson').addEventListener('click', () => {
    const data = loadCharacters();
    const exportPayload = buildExportPayload(data);
    const blob = new Blob([JSON.stringify(exportPayload, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'nora_characters.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById('importJson').addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'application/json';
    input.onchange = (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          const characters = Array.isArray(parsed)
            ? parsed
            : (parsed && Array.isArray(parsed.characters) ? parsed.characters : null);
          if (characters) {
            const cleaned = characters.map(sanitizeCharacter).filter(Boolean);
            saveCharacters(cleaned);
            renderList();
          } else {
            alert('Invalid JSON format. Expecting an array of characters or { characters: [] }.');
          }
        } catch {
          alert('Could not read JSON file.');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  });

  // Build initial UI
  createSkills();
  createInventory();
  renderList();
</script>
</body>
</html>
