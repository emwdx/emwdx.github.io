<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Markdown + LaTeX Editor</title>

<!-- Bootstrap 5 & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- KaTeX (Math Rendering) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- Marked.js (Markdown Parser) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- PDF/Image Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>

<style>
  :root{ --page-bg:#ffffff; --ink:#111; --ui-bg:#f8f9fa; --page-height:11in; }
  @media (prefers-color-scheme: dark){
    :root{ --page-bg:#ffffff; --ink:#111; --ui-bg:#0b0e12; }
    body{ color-scheme: dark; }
  }
  body{ background:var(--ui-bg); }
  
  /* The "Paper" Sheet */
  .page {
    background: var(--page-bg);
    color: var(--ink);
    width: 8.5in;
    min-height: 11in;
    padding: 0.25in; /* Standard 1 inch margins */
    box-shadow: 0 0.5rem 2rem rgba(0,0,0,.15);
    margin-bottom: 2rem;
    box-sizing: border-box;
    overflow: hidden;
    position: relative;
    /* Typography */
    font-family: "Helvetica Neue", Times, serif;
    font-size: 11pt;
    line-height: 1.5;
  }

  /* Visual page-break guides (preview only) */
  @media screen {
    .page.show-guides {
      background-image: repeating-linear-gradient(
        to bottom,
        transparent 0,
        transparent calc(var(--page-height) - 2px),
        rgba(0,0,0,0.08) calc(var(--page-height) - 2px),
        rgba(0,0,0,0.08) calc(var(--page-height) + 2px),
        transparent calc(var(--page-height) + 2px)
      );
      background-size: 100% var(--page-height);
      background-repeat: repeat-y;
    }
  }

  /* HTML typography within the page */
  .page h1, .page h2, .page h3 { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; color: #000; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: bold; }
  .page h1 { font-size: 16pt; border-bottom: 2px solid #eee; padding-bottom: 10px; }
  .page h2 { font-size: 12pt; border-bottom: 1px solid #eee; padding-bottom: 5px; }
  .page h3 { font-size: 10pt; }
  .page p { margin-bottom: 1em; text-align: justify; font-size:10pt;}
  .page ul, .page ol { margin-bottom: 1em; padding-left: 2em; }
  .page li { margin-bottom: 0.25em; }
  .page hr { border-top: 1px solid #ccc; opacity: 1; margin: 2em 0; }
  .page blockquote { border-left: 4px solid #ddd; padding-left: 1em; color: #555; margin-left: 0; font-style: italic; }
  .page table { width: 100%; border-collapse: collapse; margin: 1.25em 0; font-size: 12pt; }
  .page th, .page td { border: 1px solid #c8c8c8; padding: 8px 10px; vertical-align: top; }
  .page th { background: #f2f2f2; font-weight: bold; }
  .page tr:nth-child(even) td { background: #fafafa; }
  .page caption { caption-side: bottom; text-align: left; color: #666; font-size: 10pt; padding-top: 6px; }

  /* Editor Textarea */
  #src { resize: none; outline: none; box-shadow: none; background: var(--page-bg); color: var(--ink); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 0.9rem; }

  .sticky-toolbar{ position: sticky; top: 0; z-index: 10; background: var(--ui-bg); }
  .btn-icon{ display:inline-flex; align-items:center; gap:.35rem }

  @media print{ .no-print{ display:none !important } .page{ box-shadow:none; margin:0; background-image:none !important; } body{ background:#fff } }
</style>
</head>
<body>

<div class="container py-3">
  <!-- Toolbar -->
  <div class="sticky-toolbar py-2 mb-3 border-bottom">
    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="fs-5 fw-semibold">MD + LaTeX Editor</span>
        <span id="status" class="badge text-bg-success ms-1">Live</span>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <button id="renderBtn" class="btn btn-sm btn-primary btn-icon"><i class="bi bi-arrow-clockwise"></i><span>Refresh</span></button>
        <button id="pdfBtn" class="btn btn-sm btn-outline-primary btn-icon"><i class="bi bi-filetype-pdf"></i><span>PDF</span></button>
        <button id="pngBtn" class="btn btn-sm btn-outline-secondary btn-icon"><i class="bi bi-image"></i><span>PNG</span></button>
        <div class="input-group input-group-sm" style="width:auto">
          <label class="input-group-text" for="paper">Size</label>
          <select id="paper" class="form-select">
            <option value="letter" selected>Letter</option>
            <option value="a4">A4</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="row g-3">
    <!-- Input Column -->
    <div class="col-12 col-lg-5 d-flex flex-column">
      <div class="card shadow-sm flex-grow-1" style="height: 85vh;">
        <div class="card-header d-flex align-items-center justify-content-between py-2">
          <span class="fw-semibold small">Markdown Source</span>
          <small class="text-secondary">Use # for Headers, $ for Math</small>
        </div>
        <div class="card-body p-0 h-100">
          <textarea id="src" class="form-control border-0 rounded-0 h-100 p-3">




---
</textarea>
        </div>
      </div>
    </div>

    <!-- Preview Column -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm bg-body-tertiary" style="height: 85vh; overflow-y: auto;">
        <div class="card-header py-2"><span class="fw-semibold small">Document Preview</span></div>
        <div class="card-body d-flex justify-content-center p-4">
          <div class="page" id="page">
            <div id="output"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 1. INITIALIZATION
  const srcEl = document.getElementById('src');
  const outEl = document.getElementById('output');
  const pageEl = document.getElementById('page');
  const statusEl = document.getElementById('status');
  const paperSelect = document.getElementById('paper');
  const STORAGE_KEY = 'latex_renderer_src';

  // Enable GitHub-flavored Markdown so tables render properly
  marked.setOptions({ gfm: true, breaks: false });

  // Paper Sizing
  paperSelect.addEventListener('change', (e) => setPaperSize(e.target.value));

  // 2. THE RENDERING PIPELINE
  function render() {
    let text = srcEl.value || "";

    // STEP A: Protect LaTeX Math
    // We replace math blocks with a unique placeholder so marked.js doesn't mess them up.
    // Regex covers: $$...$$, $...$, \[...\], \(...\)
    const mathMap = new Map();
    let mathIndex = 0;
    
    text = text.replace(/(\$\$[\s\S]*?\$\$)|(\\\([\s\S]*?\\\))|(\\\[[\s\S]*?\\\])|(\$[^\$\n]*?\$)/g, (match) => {
      // Store the math
      const key = `%%%MATH${mathIndex}%%%`;
      mathMap.set(key, match);
      mathIndex++;
      return key; 
    });

    // STEP B: Parse Markdown -> HTML
    // "breaks: true" turns newlines into <br> (optional, set false if you want standard MD behavior)
    let html = marked.parse(text);

    // STEP C: Restore LaTeX Math
    mathMap.forEach((value, key) => {
      html = html.replace(key, value);
    });

    // Update DOM
    outEl.innerHTML = html;

    // STEP D: Render KaTeX
    if (window.renderMathInElement) {
      renderMathInElement(outEl, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError: false
      });
    }
  }

  // 3. DEBOUNCING (Performance)
  function debounce(func, wait) {
    let timeout;
    return function() {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, arguments), wait);
    };
  }
  
  const debouncedRender = debounce(render, 300);
  srcEl.addEventListener('input', (e) => {
    localStorage.setItem(STORAGE_KEY, e.target.value);
    debouncedRender();
  });
  document.getElementById('renderBtn').addEventListener('click', render);

  // 4. EXPORT FUNCTIONS
  function getFilename() {
    // Try to find the first H1 tag for filename
    const h1 = outEl.querySelector('h1');
    const name = h1 ? h1.innerText : 'document';
    return name.replace(/[^a-z0-9]/gi, '_').substring(0, 30);
  }

  async function savePDF() {
    await render();
    const hadGuides = pageEl.classList.contains('show-guides');
    if (hadGuides) pageEl.classList.remove('show-guides');
    const opt = {
      margin: 0,
      filename: getFilename() + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    try {
      await html2pdf().set(opt).from(pageEl).save();
    } finally {
      if (hadGuides) pageEl.classList.add('show-guides');
    }
  }

  async function savePNG() {
    await render();
    const hadGuides = pageEl.classList.contains('show-guides');
    if (hadGuides) pageEl.classList.remove('show-guides');
    try {
      const canvas = await html2canvas(pageEl, { scale: 2, backgroundColor: '#ffffff' });
      const link = document.createElement('a');
      link.download = getFilename() + '.png';
      link.href = canvas.toDataURL();
      link.click();
    } finally {
      if (hadGuides) pageEl.classList.add('show-guides');
    }
  }

  function setPaperSize(size) {
    if (size === 'a4') {
      pageEl.style.width = '8.27in';
      pageEl.style.minHeight = '11.69in';
      pageEl.style.setProperty('--page-height', '11.69in');
    } else {
      pageEl.style.width = '8.5in';
      pageEl.style.minHeight = '11in';
      pageEl.style.setProperty('--page-height', '11in');
    }
  }

  document.getElementById('pdfBtn').addEventListener('click', savePDF);
  document.getElementById('pngBtn').addEventListener('click', savePNG);

  // 5. LOAD EXAMPLE CONTENT
  // Loading your specific example into the textarea on startup
  const exampleContent = ``;

  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved !== null) {
    srcEl.value = saved;
  }
  //srcEl.value = exampleContent;
  pageEl.classList.add('show-guides');
  setPaperSize(paperSelect.value);
  render();

</script>
</body>
</html>
