<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Markdown + LaTeX Editor</title>

<!-- Bootstrap 5 & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- KaTeX (Math Rendering) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- Marked.js (Markdown Parser) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- PDF/Image Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>

<style>
  :root{ --page-bg:#ffffff; --ink:#111; --ui-bg:#f8f9fa; }
  @media (prefers-color-scheme: dark){
    :root{ --page-bg:#ffffff; --ink:#111; --ui-bg:#0b0e12; }
    body{ color-scheme: dark; }
  }
  body{ background:var(--ui-bg); }
  
  /* The "Paper" Sheet */
  .page {
    background: var(--page-bg);
    color: var(--ink);
    width: 8.5in;
    min-height: 11in;
    padding: 1in; /* Standard 1 inch margins */
    box-shadow: 0 0.5rem 2rem rgba(0,0,0,.15);
    margin-bottom: 2rem;
    box-sizing: border-box;
    overflow: hidden;
    /* Typography */
    font-family: "Times New Roman", Times, serif;
    font-size: 12pt;
    line-height: 1.5;
  }

  /* HTML typography within the page */
  .page h1, .page h2, .page h3 { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; color: #000; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: bold; }
  .page h1 { font-size: 24pt; border-bottom: 2px solid #eee; padding-bottom: 10px; }
  .page h2 { font-size: 18pt; border-bottom: 1px solid #eee; padding-bottom: 5px; }
  .page h3 { font-size: 14pt; }
  .page p { margin-bottom: 1em; text-align: justify; }
  .page ul, .page ol { margin-bottom: 1em; padding-left: 2em; }
  .page li { margin-bottom: 0.25em; }
  .page hr { border-top: 1px solid #ccc; opacity: 1; margin: 2em 0; }
  .page blockquote { border-left: 4px solid #ddd; padding-left: 1em; color: #555; margin-left: 0; font-style: italic; }

  /* Editor Textarea */
  #src { resize: none; outline: none; box-shadow: none; background: var(--page-bg); color: var(--ink); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 0.9rem; }

  .sticky-toolbar{ position: sticky; top: 0; z-index: 10; background: var(--ui-bg); }
  .btn-icon{ display:inline-flex; align-items:center; gap:.35rem }

  @media print{ .no-print{ display:none !important } .page{ box-shadow:none; margin:0; } body{ background:#fff } }
</style>
</head>
<body>

<div class="container py-3">
  <!-- Toolbar -->
  <div class="sticky-toolbar py-2 mb-3 border-bottom">
    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="fs-5 fw-semibold">MD + LaTeX Editor</span>
        <span id="status" class="badge text-bg-success ms-1">Live</span>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <button id="renderBtn" class="btn btn-sm btn-primary btn-icon"><i class="bi bi-arrow-clockwise"></i><span>Refresh</span></button>
        <button id="pdfBtn" class="btn btn-sm btn-outline-primary btn-icon"><i class="bi bi-filetype-pdf"></i><span>PDF</span></button>
        <button id="pngBtn" class="btn btn-sm btn-outline-secondary btn-icon"><i class="bi bi-image"></i><span>PNG</span></button>
        <div class="input-group input-group-sm" style="width:auto">
          <label class="input-group-text" for="paper">Size</label>
          <select id="paper" class="form-select">
            <option value="letter" selected>Letter</option>
            <option value="a4">A4</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="row g-3">
    <!-- Input Column -->
    <div class="col-12 col-lg-5 d-flex flex-column">
      <div class="card shadow-sm flex-grow-1" style="height: 85vh;">
        <div class="card-header d-flex align-items-center justify-content-between py-2">
          <span class="fw-semibold small">Markdown Source</span>
          <small class="text-secondary">Use # for Headers, $ for Math</small>
        </div>
        <div class="card-body p-0 h-100">
          <textarea id="src" class="form-control border-0 rounded-0 h-100 p-3"></textarea>
        </div>
      </div>
    </div>

    <!-- Preview Column -->
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm bg-body-tertiary" style="height: 85vh; overflow-y: auto;">
        <div class="card-header py-2"><span class="fw-semibold small">Document Preview</span></div>
        <div class="card-body d-flex justify-content-center p-4">
          <div class="page" id="page">
            <div id="output"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 1. INITIALIZATION
  const srcEl = document.getElementById('src');
  const outEl = document.getElementById('output');
  const pageEl = document.getElementById('page');
  const statusEl = document.getElementById('status');

  // Paper Sizing
  document.getElementById('paper').addEventListener('change', (e) => {
    if(e.target.value === 'a4') { pageEl.style.width = '8.27in'; pageEl.style.minHeight = '11.69in'; }
    else { pageEl.style.width = '8.5in'; pageEl.style.minHeight = '11in'; }
  });

  // 2. THE RENDERING PIPELINE
  function render() {
    let text = srcEl.value || "";

    // STEP A: Protect LaTeX Math
    // We replace math blocks with a unique placeholder so marked.js doesn't mess them up.
    // Regex covers: $$...$$, $...$, \[...\], \(...\)
    const mathMap = new Map();
    let mathIndex = 0;
    
    text = text.replace(/(\$\$[\s\S]*?\$\$)|(\\\([\s\S]*?\\\))|(\\\[[\s\S]*?\\\])|(\$[^\$\n]*?\$)/g, (match) => {
      // Store the math
      const key = `%%%MATH${mathIndex}%%%`;
      mathMap.set(key, match);
      mathIndex++;
      return key; 
    });

    // STEP B: Parse Markdown -> HTML
    // "breaks: true" turns newlines into <br> (optional, set false if you want standard MD behavior)
    let html = marked.parse(text, { breaks: false });

    // STEP C: Restore LaTeX Math
    mathMap.forEach((value, key) => {
      html = html.replace(key, value);
    });

    // Update DOM
    outEl.innerHTML = html;

    // STEP D: Render KaTeX
    if (window.renderMathInElement) {
      renderMathInElement(outEl, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError: false
      });
    }
  }

  // 3. DEBOUNCING (Performance)
  function debounce(func, wait) {
    let timeout;
    return function() {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, arguments), wait);
    };
  }
  
  srcEl.addEventListener('input', debounce(render, 300));
  document.getElementById('renderBtn').addEventListener('click', render);

  // 4. EXPORT FUNCTIONS
  function getFilename() {
    // Try to find the first H1 tag for filename
    const h1 = outEl.querySelector('h1');
    const name = h1 ? h1.innerText : 'document';
    return name.replace(/[^a-z0-9]/gi, '_').substring(0, 30);
  }

  async function savePDF() {
    await render();
    const opt = {
      margin: 0,
      filename: getFilename() + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(pageEl).save();
  }

  async function savePNG() {
    await render();
    const canvas = await html2canvas(pageEl, { scale: 2, backgroundColor: '#ffffff' });
    const link = document.createElement('a');
    link.download = getFilename() + '.png';
    link.href = canvas.toDataURL();
    link.click();
  }

  document.getElementById('pdfBtn').addEventListener('click', savePDF);
  document.getElementById('pngBtn').addEventListener('click', savePNG);

  // 5. LOAD EXAMPLE CONTENT
  // Loading your specific example into the textarea on startup
  const exampleContent = `
## 2. Core Facts to Have in Your Head

### 2.1 Basic properties of $$\ln x$$

For $$x > 0$$:

- $$\ln(ab) = \ln a + \ln b$$
- $$\ln\left(\dfrac{a}{b}\right) = \ln a - \ln b$$
- $$\ln(a^r) = r \ln a$$

These are super useful when simplifying before differentiating.

---

### 2.2 Derivatives involving $$\ln$$

For $$x > 0$$:

- $$\dfrac{d}{dx}[\ln x] = \dfrac{1}{x}$$  
- More generally, if $$f(x) > 0$$ is differentiable:
  $$\dfrac{d}{dx}[\ln(f(x))] = \dfrac{f'(x)}{f(x)}$$

Using the chain rule:

- $$\dfrac{d}{dx}[\ln(3x^2+1)] = \dfrac{6x}{3x^2+1}$$
- $$\dfrac{d}{dx}[\ln(\sin x)] = \dfrac{\cos x}{\sin x} = \cot x$$ (for $$0<x<\pi$$)

---

### 2.3 Integrals that produce $$\ln$$

- $$\displaystyle \int \frac{1}{x} \, dx = \ln|x| + C$$  
- More generally:
  $$\displaystyle \int \frac{f'(x)}{f(x)} \, dx = \ln|f(x)| + C$$

Examples:

- $$\displaystyle \int \frac{6x}{3x^2+1} \, dx = \ln|3x^2+1| + C$$
- $$\displaystyle \int \frac{\cos x}{\sin x} \, dx = \ln|\sin x| + C$$

Also:

- $$\displaystyle \int \frac{1}{ax+b} \, dx = \frac{1}{a} \ln|ax+b| + C$$

---
`;

  srcEl.value = exampleContent;
  render();

</script>
</body>
</html>
