<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Speed Meeting</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root {
      --custom-primary-light: #eafce2;
      --custom-primary: #c5eab2;
      --custom-primary-bright: #b2ff8b;
      --custom-primary-darker: #89be6d;
      --custom-box-bg: #f4f3e8;
    }
    @media (max-width: 991.98px) {
      .layout-swapper {
        grid-template-columns: 1fr;
      }
      #activityLayout #timerCard,
      #activityLayout #groupsPanelWrapper {
        grid-column: 1 / -1;
      }
      #activityLayout.groups-collapsed #groupsPanelWrapper {
        max-width: 100%;
        min-width: 100%;
      }
    }

    html,
    body {
      height: 100%;
    }

    body {
      background-color: var(--bs-white);
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen,
        Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;
    }

    body.activity-active {
      overflow-y: auto;
    }
    body.activity-active > .container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    body.activity-active h1 {
      margin-top: 0.5rem !important;
      margin-bottom: 1rem !important;
    }

    h1 {
      font-weight: 800;
    }

    .setup-card,
    .controls-card,
    .content-card {
      background-color: var(--custom-box-bg);
      border: none;
      border-radius: 1rem;
    }

    .setup-card .form-control,
    .setup-card .form-select,
    .setup-card .input-group-text {
      border-radius: 0.5rem;
      border: 1px solid var(--bs-white);
    }

    .setup-card .form-control:focus,
    .setup-card .form-select:focus {
      border-color: var(--custom-primary-darker);
      box-shadow: 0 0 0 0.25rem rgba(137, 190, 109, 0.5);
    }

    #studentNames.form-control {
      border-radius: 1rem;
      background-color: #fff;
      border: 1px solid #fff;
      padding: 1rem;
      min-height: 260px;
    }

    #studentNames::-webkit-scrollbar {
      width: 10px;
    }

    #studentNames::-webkit-scrollbar-track {
      background: transparent;
    }

    #studentNames::-webkit-scrollbar-thumb {
      background-color: var(--custom-primary);
      border-radius: 20px;
      border: 3px solid var(--bs-white);
    }

    .btn {
      border-radius: 50rem;
      font-weight: 600;
      padding: 0.75rem 1.25rem;
    }

    .btn-start-activity {
      background-color: var(--custom-primary-bright);
      color: var(--bs-black);
      border: none;
    }

    .btn-start-activity:hover {
      background-color: var(--custom-primary-darker);
      color: var(--bs-black);
    }

    .btn-save {
      background-color: transparent;
      border: none;
      color: var(--custom-primary-darker);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
    }

    .btn-save:hover {
      background-color: rgba(0, 0, 0, 0.05);
      color: var(--custom-primary-darker);
    }

    .btn-pulse {
      padding: 1rem 2rem;
      font-size: 1.25rem;
      box-shadow: 0 0 0 0 rgba(178, 255, 139, 1);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.97);
        box-shadow: 0 0 0 0 rgba(178, 255, 139, 0.7);
      }
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 25px rgba(178, 255, 139, 0);
      }
      100% {
        transform: scale(0.97);
        box-shadow: 0 0 0 0 rgba(178, 255, 139, 0);
      }
    }

    /* Pairing grid + cards */
    #pairingContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 1.25rem;
      min-height: 40vh;
      align-content: start;
      perspective: 1200px;
      transition: opacity 0.3s ease;
    }
    #pairingContainer.groups-hidden {
      opacity: 0;
      pointer-events: none;
    }
    #groupsWrapper {
      display: contents;
    }
    .flip-card {
      background-color: transparent;
      min-height: 190px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.8s;
    }
    .flip-card.is-flipped {
      transform: rotateY(180deg);
    }
    .card-face {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
    }
    .card-face--back {
      transform: rotateY(180deg);
    }
    .group-card {
      border-radius: 0.75rem;
      border: none;
      background-color: #fff;
      height: 100%;
      box-shadow: 0 1.25rem 2.5rem -1.5rem rgba(0, 0, 0, 0.2);
    }
    .group-card .card-header {
      border-radius: 0.75rem 0.75rem 0 0;
      height: 8px;
      padding: 0;
      border-bottom: none;
    }
    .group-card .card-title {
      font-weight: 700;
      margin-top: 0.75rem;
      font-size: 1.1rem;
      text-align: center;
    }
    .group-card .list-unstyled li {
      text-align: left;
      font-size: 1.05rem;
      padding-left: 1.25rem;
      margin-top: 0.25rem;
    }

    .final-message-container {
      grid-column: 1 / -1;
    }

    .action-headline {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
    }
    .action-subtext {
      text-align: center;
      color: #5f6b7a;
      max-width: 480px;
      margin: 0 auto;
    }

    /* Timer */
    .layout-swapper {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 1.5rem;
      transition: grid-template-columns 0.4s ease;
    }
    @media (min-width: 992px) {
      .layout-swapper {
        grid-template-columns: repeat(12, 1fr);
      }
      .layout-swapper.timer-focus #timerCard {
        grid-column: 1 / span 8;
      }
      .layout-swapper.timer-focus #groupsPanelWrapper {
        grid-column: 9 / span 4;
      }
      .layout-swapper.groups-focus #timerCard {
        grid-column: 1 / span 5;
      }
      .layout-swapper.groups-focus #groupsPanelWrapper {
        grid-column: 6 / span 7;
      }
      .layout-swapper.groups-collapsed #timerCard {
        grid-column: 1 / span 12;
      }
      .layout-swapper.groups-collapsed #groupsPanelWrapper {
        grid-column: 12 / span 1;
      }
    }
    #timerCard {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: clamp(1rem, 2.5vh, 2rem);
      transition: transform 0.4s ease, box-shadow 0.4s ease, opacity 0.3s ease;
      width: 100%;
      margin: 0 auto;
      padding: clamp(1.25rem, 3.5vw, 3rem);
      max-width: 860px;
    }
    #groupsPanelWrapper {
      transition: transform 0.4s ease, box-shadow 0.4s ease, opacity 0.3s ease;
    }
    .layout-swapper.timer-focus #timerCard {
      transform: scale(1);
      box-shadow: 0 2rem 4rem -3rem rgba(0, 0, 0, 0.4);
    }
    .layout-swapper.timer-focus #groupsPanelWrapper {
      transform: scale(0.96);
      opacity: 0.85;
    }
    .layout-swapper.groups-focus #timerCard {
      transform: scale(0.9);
      opacity: 0.85;
    }
    .layout-swapper.groups-focus #groupsPanelWrapper {
      transform: scale(1.02);
      box-shadow: 0 2rem 4rem -2.5rem rgba(0, 0, 0, 0.35);
    }
    .layout-swapper.groups-collapsed #timerCard {
      transform: scale(1);
      opacity: 1;
    }
    .layout-swapper.groups-collapsed #groupsPanelWrapper {
      transform: none;
      opacity: 1;
    }
    .layout-swapper.timer-focus.groups-collapsed #pairingContainer {
      pointer-events: none;
    }
    .layout-swapper.timer-focus:not(.groups-collapsed) #pairingContainer,
    .layout-swapper.groups-focus #pairingContainer {
      pointer-events: auto;
    }

    #groupsPanelWrapper {
      display: flex;
      align-items: stretch;
      height: 100%;
    }
    .groups-panel-inner {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      width: 100%;
      height: 100%;
      position: relative;
    }
    #groupsPanel {
      max-width: 560px;
      width: 100%;
    }
    .groups-header {
      position: sticky;
      top: 0;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: inherit;
      padding-bottom: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .groups-collapse-btn {
      display: grid;
      place-items: center;
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #fff;
      color: #4a4a4a;
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .groups-collapse-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #000;
      box-shadow: 0 0.75rem 1.5rem -1rem rgba(0, 0, 0, 0.2);
    }
    .groups-collapse-btn .chevron {
      font-size: 1.15rem;
      line-height: 1;
      transition: transform 0.3s ease;
      display: inline-block;
    }
    .groups-header-text h4 {
      margin-bottom: 0.35rem;
    }
    #groupsPanelContent {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      overflow-y: auto;
      padding-right: 0.25rem;
    }
    #groupsPanelContent > #pairingContainer {
      flex: 1 1 auto;
      min-height: 0;
    }
    #activityLayout.groups-collapsed #groupsPanelWrapper {
      max-width: 64px;
      min-width: 52px;
      justify-self: end;
    }
    #activityLayout.groups-collapsed #groupsPanelContent,
    #activityLayout.groups-collapsed .groups-header-text {
      display: none !important;
    }
    #activityLayout.groups-collapsed .groups-panel-inner {
      align-items: center;
      justify-content: flex-start;
      padding: 0.75rem 0.5rem;
      gap: 0.5rem;
    }
    #activityLayout.groups-collapsed #groupsPanel {
      background: transparent;
      box-shadow: none;
      border: none;
      padding: 0.5rem;
    }
    #activityLayout.groups-collapsed .groups-collapse-btn .chevron {
      transform: rotate(180deg);
    }
    #activityLayout.groups-collapsed .groups-collapse-btn {
      position: sticky;
      top: 0.5rem;
    }

    #activityScreen.layout-ready {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      min-height: calc(100vh - 2rem);
    }
    #activityScreen.layout-ready #activityLayout {
      flex: 1 1 auto;
      min-height: 0;
    }

    .timer-wrap {
      position: relative;
      width: clamp(240px, min(48vw, 60vh), 520px);
      height: clamp(240px, min(48vw, 60vh), 520px);
      margin: clamp(4px, 2vh, 20px) auto;
    }
    .timer-stack {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: clamp(0.75rem, 2vw, 1.5rem);
      width: 100%;
      position: relative;
      padding-top: clamp(1.75rem, 4vh, 3rem);
      padding-bottom: clamp(0.75rem, 3vh, 2rem);
    }

    .timer-stack #statusPill {
      position: absolute;
      top: clamp(-0.5rem, 1vh, 0.75rem);
      left: 50%;
      transform: translateX(-50%);
    }

    #timer-canvas {
      width: 100%;
      height: 100%;
    }

    #timer-display {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-weight: 800;
      font-size: 2.25rem;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .status-pill {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      font-weight: 700;
      border-radius: 2rem;
    }

    .status-transition {
      background: #ffe8a3;
      color: #5f4c00;
    }

    .status-meet {
      background: #c7ffd0;
      color: #0d5b1f;
    }

    .timer-card.show-digits #timer-display {
      opacity: 1;
    }

    #timelineWrapper {
      width: 100%;
      margin-top: 1.25rem;
    }
    .timeline-track {
      position: relative;
      height: 12px;
      border-radius: 999px;
      background: #e9ecef;
      overflow: hidden;
    }
    #timelineSegments,
    #timelineDots {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .timeline-progress {
      position: absolute;
      inset: 0;
      width: 0%;
      background: linear-gradient(90deg, #b2ff8b, #89be6d);
      transition: width 0.4s ease;
    }
    .timeline-segment {
      position: absolute;
      top: 0;
      height: 100%;
      border-radius: 999px;
      opacity: 0.45;
    }
    .timeline-segment.transition {
      background: #ffe8a3;
    }
    .timeline-segment.meet {
      background: #c7ffd0;
    }
    .timeline-dot {
      position: absolute;
      top: 50%;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      border: 3px solid #fff;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.15);
      background: #89be6d;
    }
    .timeline-dot.transition {
      background: #d9a94b;
    }

    /* Report tables */
    .report-card .list-group-item,
    #reportModal .list-group-item {
      background-color: var(--custom-box-bg);
    }
  </style>
</head>
<body class="p-3">
  <div class="container">
    <h1 class="text-center my-4">Student Pairing Tool</h1>

    <!-- SETUP SCREEN -->
    <section id="setupScreen">
      <div class="card setup-card p-4 mx-auto" style="max-width: 980px;">
        <div class="row g-4">
          <div class="col-md-7">
            <div class="d-flex flex-column h-100">
              <div class="mb-3">
                <label class="form-label fw-bold">Choose Class</label>
                <div class="input-group">
                  <select class="form-select" id="classDropdown">
                    <option selected>New Class</option>
                  </select>
                  <button class="btn btn-outline-secondary btn-sm" id="addNewClassButton" type="button" title="Add New Class">+</button>
                  <button class="btn btn-outline-danger btn-sm" id="deleteClassButton" type="button" title="Delete Selected Class">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                  </button>
                </div>
              </div>
              <label for="studentNames" class="form-label fw-bold">Enter Students</label>
              <textarea id="studentNames" class="form-control flex-grow-1" placeholder="Olivia&#10;Liam&#10;Sophia&#10;Jackson&#10;Ava"></textarea>
            </div>
          </div>
          <div class="col-md-5 d-flex flex-column">
            <div>
              <label class="form-label fw-bold">Total Activity Time</label>
              <div class="input-group mb-3">
                <input type="number" id="totalTimeMinutes" value="1" min="0" class="form-control text-center" />
                <span class="input-group-text">min</span>
                <input type="number" id="totalTimeSeconds" value="0" min="0" max="59" class="form-control text-center" />
                <span class="input-group-text">sec</span>
              </div>
            </div>
            <div>
              <label class="form-label fw-bold">Group Meeting Time</label>
              <div class="input-group mb-3">
                <input type="number" id="groupTimeMinutes" value="0" min="0" class="form-control text-center" />
                <span class="input-group-text">min</span>
                <input type="number" id="groupTimeSeconds" value="25" min="0" max="59" class="form-control text-center" />
                <span class="input-group-text">sec</span>
              </div>
            </div>
            <div>
              <label class="form-label fw-bold">Transition Time</label>
              <div class="input-group mb-3">
                <input type="number" id="transitionTimeSeconds" value="10" min="0" max="120" class="form-control text-center" />
                <span class="input-group-text">sec</span>
              </div>
            </div>
            <div class="mt-auto">
              <button class="btn btn-start-activity btn-lg w-100" id="startButton">Start Activity</button>
              <button class="btn btn-save w-100 mt-2" id="saveClassButton">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v4.5h2a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 5.5 6.5h2V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1z"/></svg>
                Save Class
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ACTIVITY SCREEN -->
    <section id="activityScreen" class="d-none">
      <div id="activityLayout" class="layout-swapper timer-focus">
        <div id="timerCard" class="card controls-card flex-grow-1 d-flex flex-column align-items-center timer-card">
          <div class="timer-stack w-100 d-flex flex-column align-items-center gap-3">
            <span id="statusPill" class="status-pill status-transition">Get ready</span>
            <div class="timer-wrap" id="conversationTimerWrap">
              <canvas id="timer-canvas" width="520" height="520"></canvas>
              <div id="timer-display">00:00</div>
            </div>
            <div id="timerMessage" class="text-center">
              <div id="actionHeadline" class="action-headline mb-2">Prepare to find your partner</div>
              <p id="actionSubtext" class="action-subtext">Click “Reveal Groups” to show everyone where to go.</p>
            </div>
          </div>
          <div id="timelineWrapper">
            <div class="timeline-track">
              <div id="timelineSegments"></div>
              <div id="timelineProgress" class="timeline-progress"></div>
              <div id="timelineDots"></div>
            </div>
            <div class="d-flex justify-content-between small text-muted mt-2">
              <span id="timelineLabelStart">00:00</span>
              <span id="timelineLabelEnd">00:00 total</span>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 justify-content-center mt-4 w-100">
            <button class="btn btn-secondary" id="pauseResumeBtn">Pause</button>
            <button class="btn btn-secondary" id="regroupBtn">Regroup Now</button>
            <button class="btn btn-outline-secondary" id="toggleDigitsBtn">Show Digits</button>
            <button class="btn btn-danger" id="endActivityBtn">End Activity</button>
          </div>
        </div>
        <div id="groupsPanelWrapper" class="d-flex">
          <div class="card content-card p-4 flex-grow-1 groups-panel-inner" id="groupsPanel">
            <div class="groups-header">
              <button class="groups-collapse-btn" id="toggleGroupsPaneBtn" type="button" aria-expanded="true" aria-label="Hide groups">
                <span class="chevron">&#9654;</span>
              </button>
              <div class="groups-header-text">
                <h4 class="mb-1" id="groupsPanelHeading">Group Finder</h4>
                <p class="text-muted small mb-0" id="groupsHelperText">Reveal the cards when you are ready.</p>
              </div>
            </div>
            <div id="groupsPanelContent">
              <div class="d-flex justify-content-end">
                <button class="btn btn-start-activity" id="revealGroupsBtn">Reveal Groups</button>
              </div>
              <div id="pairingContainer"></div>
              <div class="pt-2">
                <button class="btn btn-start-activity d-none w-100" id="beginRoundBtn">Start Round</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- REPORT SCREEN -->
    <section id="reportScreen" class="d-none">
      <div class="card content-card p-4 mx-auto" style="max-width: 1000px;">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h3 class="mb-0">Activity Report</h3>
          <button id="runAgainBtn" class="btn btn-secondary">Run Again</button>
        </div>
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="card report-card h-100">
              <div class="card-body">
                <h5 class="card-title">Pairings by Round</h5>
                <div id="roundsReport" class="list-group list-group-flush"></div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card report-card h-100">
              <div class="card-body">
                <h5 class="card-title">Individual Meeting Summary</h5>
                <ul id="individualReport" class="list-group list-group-flush"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---------- STATE + DOM -----------
    const STORAGE_KEY = 'studentPairingClasses_v2';

    const setupScreen = document.getElementById('setupScreen');
    const activityScreen = document.getElementById('activityScreen');
    const reportScreen = document.getElementById('reportScreen');

    const startButton = document.getElementById('startButton');
    const saveClassButton = document.getElementById('saveClassButton');
    const deleteClassButton = document.getElementById('deleteClassButton');
    const addNewClassButton = document.getElementById('addNewClassButton');
    const classDropdown = document.getElementById('classDropdown');
    const studentNamesTextarea = document.getElementById('studentNames');

    const revealGroupsBtn = document.getElementById('revealGroupsBtn');
    const beginRoundBtn = document.getElementById('beginRoundBtn');
    const pauseResumeBtn = document.getElementById('pauseResumeBtn');
    const regroupBtn = document.getElementById('regroupBtn');
    const endActivityBtn = document.getElementById('endActivityBtn');
    const runAgainBtn = document.getElementById('runAgainBtn');
    const toggleDigitsBtn = document.getElementById('toggleDigitsBtn');
    const toggleGroupsPaneBtn = document.getElementById('toggleGroupsPaneBtn');

    const timerCanvas = document.getElementById('timer-canvas');
    const ctx = timerCanvas.getContext('2d');
    const timerDisplay = document.getElementById('timer-display');
    const statusPill = document.getElementById('statusPill');
    const actionHeadline = document.getElementById('actionHeadline');
    const actionSubtext = document.getElementById('actionSubtext');
    const activityLayout = document.getElementById('activityLayout');
    const timerCard = document.getElementById('timerCard');
    const timelineProgress = document.getElementById('timelineProgress');
    const timelineSegments = document.getElementById('timelineSegments');
    const timelineDots = document.getElementById('timelineDots');
    const timelineLabelStart = document.getElementById('timelineLabelStart');
    const timelineLabelEnd = document.getElementById('timelineLabelEnd');
    const groupsPanelWrapper = document.getElementById('groupsPanelWrapper');
    const pairingContainer = document.getElementById('pairingContainer');
    const groupsHelperText = document.getElementById('groupsHelperText');
    const groupsPanelHeading = document.getElementById('groupsPanelHeading');

    let timerDigitsVisible = false;
    if (timerCard) timerCard.classList.remove('show-digits');

    // --- Sounds (expects files in ./sounds) ---
    const sounds = {
      ten: new Audio('sounds/ten_sec.m4a'),
      ignition: new Audio('sounds/ignition.mp3'),
      timeUp: new Audio('sounds/time_up.m4a')
    };
    Object.values(sounds).forEach(a => {
      a.preload = 'auto';
      a.load();
      a.volume = 0.9;
    });
    function playSound(key) {
      const a = sounds[key];
      if (!a) return;
      try {
        a.pause();
        a.currentTime = 0;
        a.play().catch(() => {
          /* ignore play promise rejection (autoplay blocked) */
        });
      } catch (e) { /* ignore */ }
    }
    function stopSound(key) {
      const a = sounds[key];
      if (!a) return;
      a.pause();
      a.currentTime = 0;
      if (key === 'timeUp') timeUpPlaying = false;
    }
    let timeUpPlaying = false;
    sounds.timeUp.addEventListener('play', () => {
      timeUpPlaying = true;
    });
    ['pause', 'ended'].forEach((evt) => {
      sounds.timeUp.addEventListener(evt, () => {
        if (sounds.timeUp.paused || sounds.timeUp.currentTime === 0) {
          timeUpPlaying = false;
        }
      });
    });

    let totalTimeInSeconds = 0,
      groupTimeInSeconds = 0,
      transitionTimeInSeconds = 0,
      currentPhaseTime = 0,
      totalRemaining = 0,
      phase = 'transition', // 'transition' | 'meet'
      round = 0,
      paused = true,
      loopInterval = null;
    let pendingGroups = null; // holds the next round's groups when previewing
    let transitionCountdownStarted = false;
    let activeTransitionDuration = 0;
    let groupsRevealed = false;
    let timelineSegmentsData = [];
    let totalPlannedDuration = 0;
    let nextRoundNumber = 1;
    let groupsPanelCollapsed = false;
    let lastIgnitionRound = 0;

    const cardColors = ['#ff5f5f', '#625fff', '#5fff6f', '#ffbf5f', '#03af8d', '#6e5ef8', '#45a3ff', '#ab68e2'];

    let students = [];
    let pairingHistory = {}; // per-student set
    let roundsHistory = []; // array of arrays of groups per round

    // ---------- CLASS STORAGE -----------
    function getSavedClasses() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    }
    function saveClasses(classes) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(classes));
    }
    function populateClassDropdown() {
      const classes = getSavedClasses();
      const currentVal = classDropdown.value;
      classDropdown.innerHTML = '<option selected>New Class</option>';
      for (const className in classes) {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classDropdown.appendChild(option);
      }
      if (classes[currentVal]) classDropdown.value = currentVal;
    }

    function handleSaveClass() {
      const list = studentNamesTextarea.value
        .split('\n')
        .map((n) => n.trim())
        .filter(Boolean);
      if (list.length === 0) {
        alert('Please enter student names before saving.');
        return;
      }
      const className = prompt(
        'Enter a name for this class:',
        classDropdown.value !== 'New Class' ? classDropdown.value : ''
      );
      if (!className) return;
      const classes = getSavedClasses();
      classes[className] = list;
      saveClasses(classes);
      populateClassDropdown();
      classDropdown.value = className;
      alert(`Class "${className}" saved!`);
    }

    function handleDeleteClass() {
      const selectedClass = classDropdown.value;
      if (selectedClass === 'New Class') {
        alert("Cannot delete 'New Class'. Select a saved class to delete.");
        return;
      }
      if (confirm(`Delete the class "${selectedClass}"? This cannot be undone.`)) {
        const classes = getSavedClasses();
        delete classes[selectedClass];
        saveClasses(classes);
        classDropdown.innerHTML = '<option selected>New Class</option>';
        populateClassDropdown();
        studentNamesTextarea.value = '';
      }
    }
    function handleAddNewClass() {
      classDropdown.value = 'New Class';
      studentNamesTextarea.value = '';
      studentNamesTextarea.focus();
    }
    function handleClassChange() {
      const selectedClass = classDropdown.value;
      if (selectedClass === 'New Class') {
        studentNamesTextarea.value = '';
      } else {
        const classes = getSavedClasses();
        studentNamesTextarea.value = (classes[selectedClass] || []).join('\n');
      }
    }

    // ---------- ACTIVITY LIFECYCLE -----------
    function initActivity() {
      // ensure browser will allow subsequent programmatic playback by
      // triggering audio on this user action (best-effort)
      try { sounds.ten.play().catch(() => {}); } catch (e) {}
      if (sounds.ten) {
        stopSound('ten');
      }

      const totalMinutes = parseInt(document.getElementById('totalTimeMinutes').value) || 0;
      const totalSeconds = parseInt(document.getElementById('totalTimeSeconds').value) || 0;
      const groupMinutes = parseInt(document.getElementById('groupTimeMinutes').value) || 0;
      const groupSeconds = parseInt(document.getElementById('groupTimeSeconds').value) || 0;
      const transitionSeconds = parseInt(document.getElementById('transitionTimeSeconds').value) || 0;

      totalTimeInSeconds = totalMinutes * 60 + totalSeconds;
      groupTimeInSeconds = groupMinutes * 60 + groupSeconds;
      transitionTimeInSeconds = transitionSeconds;

      const names = studentNamesTextarea.value
        .split('\n')
        .map((n) => n.trim())
        .filter(Boolean);

      if (groupTimeInSeconds <= 0 || totalTimeInSeconds <= 0) {
        alert('Timers must be set to a value greater than zero.');
        return;
      }
      if (totalTimeInSeconds < groupTimeInSeconds) {
        alert('Total activity time must be \u2265 group time.');
        return;
      }
      if (names.length < 2) {
        alert('Please enter at least two student names.');
        return;
      }

      students = names;
      pairingHistory = {};
      students.forEach((s) => (pairingHistory[s] = new Set()));
      roundsHistory = [];

      timelineSegmentsData = buildTimelineSegments(totalTimeInSeconds, groupTimeInSeconds, transitionTimeInSeconds);
      totalPlannedDuration = timelineSegmentsData.length
        ? timelineSegmentsData[timelineSegmentsData.length - 1].end
        : totalTimeInSeconds;
      renderTimelineSegments();
      updateTimelineProgress();
      timelineLabelEnd.textContent = `${formatTime(totalPlannedDuration)} total`;

      // Screen switch
      setupScreen.classList.add('d-none');
      reportScreen.classList.add('d-none');
      activityScreen.classList.remove('d-none');
      activityScreen.classList.add('layout-ready');
      document.body.classList.add('activity-active');

      // Timer + UI reset
      totalRemaining = totalTimeInSeconds;
      paused = true; // wait for reveal/start
      phase = 'transition';
      round = 0;
      nextRoundNumber = 1;
      currentPhaseTime = transitionTimeInSeconds;
      transitionCountdownStarted = false;
      activeTransitionDuration = currentPhaseTime;
      timeUpPlaying = false;
      setStatus('transition');
      drawTimer(1, '#ffc107');
      timerDisplay.textContent = formatTime(groupTimeInSeconds);
      timerCard.classList.toggle('show-digits', timerDigitsVisible);
      toggleDigitsBtn.textContent = timerDigitsVisible ? 'Hide Digits' : 'Show Digits';
      pauseResumeBtn.textContent = 'Pause';
      pauseResumeBtn.disabled = true;
      regroupBtn.disabled = true;
      groupsRevealed = false;
      timeUpPlaying = false;
      pairingContainer.classList.remove('groups-hidden');
      groupsHelperText.textContent = 'Reveal the cards when you are ready.';
      groupsPanelHeading.textContent = 'Group Finder';
      revealGroupsBtn.classList.remove('d-none');
      revealGroupsBtn.disabled = false;
      beginRoundBtn.classList.add('d-none');
      beginRoundBtn.classList.remove('btn-pulse');

      pendingGroups = null;
      lastIgnitionRound = 0;
      prepareTransition(currentPhaseTime);

      if (loopInterval) clearInterval(loopInterval);
      loopInterval = setInterval(mainLoop, 1000);
    }

    function mainLoop() {
      if (paused) return;

      if (totalRemaining > 0) totalRemaining--;
      updateTimelineProgress();

      currentPhaseTime--;
      if (phase === 'meet') {
        if (currentPhaseTime === 10) playSound('ten');
        if (currentPhaseTime < 0) {
          stopSound('ten');
          playSound('timeUp');
          const remainingForPlanning = Math.max(totalRemaining, 0);
          const transitionBudget = Math.min(transitionTimeInSeconds, remainingForPlanning);
          const timeLeftAfterTransition = remainingForPlanning - transitionBudget;
          const enoughForAnotherRound =
            transitionBudget > 0 && timeLeftAfterTransition >= groupTimeInSeconds;
          if (!enoughForAnotherRound) {
            drawTimer(0, '#28a745');
            endActivity({ preserveFinalTone: true });
            return;
          }
          prepareTransition(transitionBudget);
          return;
        }
      } else if (phase === 'transition') {
        if (
          !transitionCountdownStarted &&
          activeTransitionDuration > 0 &&
          currentPhaseTime <= 10 &&
          currentPhaseTime >= 0 &&
          !timeUpPlaying
        ) {
          playSound('ten');
          transitionCountdownStarted = true;
        }
        if (currentPhaseTime < 0) {
          beginMeetPhase();
          return;
        }
      }

      const phaseDuration = phase === 'transition'
        ? Math.max(activeTransitionDuration, 1)
        : Math.max(groupTimeInSeconds, 1);
      const pct = phaseDuration > 0 ? Math.max(currentPhaseTime / phaseDuration, 0) : 0;
      drawTimer(pct, phase === 'transition' ? '#ffc107' : '#28a745');
      timerDisplay.textContent = formatTime(Math.max(currentPhaseTime, 0));
    }

    function endActivity(options = {}) {
      const { preserveFinalTone = false } = options;
      clearInterval(loopInterval);
      loopInterval = null;
      paused = true;
      pendingGroups = null;
      transitionCountdownStarted = false;
      activeTransitionDuration = 0;
      stopSound('ten');
      if (!preserveFinalTone) {
        stopSound('timeUp');
      }
      currentPhaseTime = 0;
      totalRemaining = 0;
      timerDisplay.textContent = formatTime(0);
      drawTimer(0, phase === 'transition' ? '#ffc107' : '#28a745');
      updateTimelineProgress();
      activityScreen.classList.add('d-none');
      activityScreen.classList.remove('layout-ready');
      document.body.classList.remove('activity-active');
      setGroupsPanelCollapsed(false);
      activityLayout.classList.remove('groups-focus', 'groups-collapsed');
      activityLayout.classList.add('timer-focus');
      lastIgnitionRound = 0;
      buildReport();
      reportScreen.classList.remove('d-none');
    }

    function runAgain() {
      reportScreen.classList.add('d-none');
      setupScreen.classList.remove('d-none');
      activityScreen.classList.remove('layout-ready');
      document.body.classList.remove('activity-active');
      pendingGroups = null;
      transitionCountdownStarted = false;
      activeTransitionDuration = 0;
      timelineSegmentsData = [];
      totalPlannedDuration = 0;
      timelineSegments.innerHTML = '';
      timelineDots.innerHTML = '';
      timelineProgress.style.width = '0%';
      timerDigitsVisible = false;
      timerCard.classList.remove('show-digits');
      toggleDigitsBtn.textContent = 'Show Digits';
      if (timelineLabelStart) timelineLabelStart.textContent = '00:00';
      if (timelineLabelEnd) timelineLabelEnd.textContent = '00:00 total';
      setGroupsPanelCollapsed(false);
      activityLayout.classList.remove('groups-focus', 'groups-collapsed');
      activityLayout.classList.add('timer-focus');
      lastIgnitionRound = 0;
    }

    // ---------- PAIRS + ROUNDS -----------
    function prepareTransition(durationOverride = null) {
      phase = 'transition';
      setStatus('transition');
      transitionCountdownStarted = false;
      groupsRevealed = false;
      setGroupsPanelCollapsed(false);
      pairingContainer.classList.remove('groups-hidden');
      activityLayout.classList.remove('timer-focus');
      activityLayout.classList.add('groups-focus');
      groupsPanelWrapper.classList.remove('d-none');
      revealGroupsBtn.classList.remove('d-none');
      revealGroupsBtn.disabled = false;
      beginRoundBtn.classList.add('d-none');
      beginRoundBtn.classList.remove('btn-pulse');
      beginRoundBtn.textContent = `Start Round ${nextRoundNumber}`;
      groupsPanelHeading.textContent = `Round ${nextRoundNumber}`;
      const transitionBudget = durationOverride !== null
        ? Math.max(durationOverride, 0)
        : Math.min(transitionTimeInSeconds, Math.max(totalRemaining, 0));
      currentPhaseTime = transitionBudget;
      activeTransitionDuration = transitionBudget;
      timerDisplay.textContent = formatTime(Math.max(currentPhaseTime, 0));
      paused = true;
      pauseResumeBtn.disabled = true;
      pauseResumeBtn.textContent = 'Pause';
      regroupBtn.disabled = true;

      if (!pendingGroups) pendingGroups = generateGroupsAvoidingRepeats();
      renderGroups(pendingGroups);
      setGroupsRevealed(false);
      groupsHelperText.textContent = 'Reveal the cards when you are ready.';
      updateActionMessage({
        headline: `Round ${nextRoundNumber}: Find your partner`,
        subtext: transitionBudget > 0
          ? 'Reveal the cards to start the transition countdown.'
          : 'No transition time is scheduled. Start the round when everyone is ready.'
      });
      drawTimer(1, '#ffc107');
      updateTimelineProgress();
    }

    function beginMeetPhase() {
      phase = 'meet';
      round = nextRoundNumber;
      nextRoundNumber++;
      setStatus('meet');
      currentPhaseTime = groupTimeInSeconds;
      transitionCountdownStarted = false;
      activeTransitionDuration = 0;
      paused = false;
      pauseResumeBtn.disabled = false;
      pauseResumeBtn.textContent = 'Pause';
      regroupBtn.disabled = false;
      stopSound('ten');
      if (lastIgnitionRound !== round) {
        stopSound('ignition');
        playSound('ignition');
        lastIgnitionRound = round;
      }
      if (!pendingGroups) pendingGroups = generateGroupsAvoidingRepeats();
      roundsHistory.push(pendingGroups.map((g) => [...g]));
      renderGroups(pendingGroups);
      pendingGroups = null;
      pairingContainer.classList.add('groups-hidden');
      setGroupsPanelCollapsed(true);
      activityLayout.classList.remove('groups-focus');
      activityLayout.classList.add('timer-focus');
      groupsHelperText.textContent = 'Next groups will appear after this round.';
      revealGroupsBtn.classList.add('d-none');
      beginRoundBtn.classList.add('d-none');
      beginRoundBtn.classList.remove('btn-pulse');
      setGroupsRevealed(false);
      updateActionMessage({
        headline: `Round ${round}: Meet!`,
        subtext: 'Focus on the conversation. The circle shows how much time remains.'
      });
      drawTimer(1, '#28a745');
      timerDisplay.textContent = formatTime(Math.max(currentPhaseTime, 0));
      if (groupTimeInSeconds > 0 && groupTimeInSeconds <= 10) {
        playSound('ten');
      }
    }

    function generateGroupsAvoidingRepeats() {
      const unpaired = [...students];
      const groups = [];

      while (unpaired.length > 0) {
        if (unpaired.length === 3) {
          groups.push([...unpaired]);
          unpaired.length = 0;
          break;
        }
        const student1 = unpaired.shift();
        // Prefer fresh partners
        const fresh = unpaired.filter((p) => !pairingHistory[student1].has(p));
        const partner = (fresh.length > 0 ? fresh : unpaired)[
          Math.floor(Math.random() * (fresh.length > 0 ? fresh.length : unpaired.length))
        ];
        groups.push([student1, partner]);
        // remove partner from unpaired
        const idx = unpaired.indexOf(partner);
        if (idx !== -1) unpaired.splice(idx, 1);
      }

      // Update history
      groups.forEach((group) => {
        group.forEach((s1) =>
          group.forEach((s2) => {
            if (s1 !== s2) pairingHistory[s1].add(s2);
          })
        );
      });

      return groups;
    }

    function renderGroups(groups) {
      let wrapper = document.getElementById('groupsWrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.id = 'groupsWrapper';
        wrapper.className = 'groups-wrapper';
        pairingContainer.appendChild(wrapper);
      }
      wrapper.innerHTML = '';
      groups.forEach((group, index) => {
        const color = cardColors[index % cardColors.length];
        const flip = document.createElement('div');
        flip.className = 'flip-card';
        flip.innerHTML = `
          <div class="card-face card-face--front">
            <div class="group-card card h-100 d-flex flex-column justify-content-center align-items-center text-center px-3">
              <div class="card-header" style="background-color:${color}"></div>
              <div class="card-body d-flex flex-column justify-content-center align-items-center">
                <h5 class="card-title mb-1">Group ${index + 1}</h5>
                <p class="text-muted small mb-0">Tap reveal to see names</p>
              </div>
            </div>
          </div>
          <div class="card-face card-face--back">
            <div class="group-card card h-100">
              <div class="card-header" style="background-color:${color}"></div>
              <div class="card-body d-flex flex-column justify-content-center">
                <h5 class="card-title text-center">Group ${index + 1}</h5>
                <ul class="list-unstyled mb-0">${group.map((n) => `<li>${n}</li>`).join('')}</ul>
              </div>
            </div>
          </div>`;
        wrapper.appendChild(flip);
      });
    }

    function buildTimelineSegments(total, meetDuration, transitionDuration) {
      const segments = [];
      if (total <= 0 || meetDuration <= 0) return segments;
      let remaining = total;
      let elapsed = 0;
      let roundIndex = 1;
      while (remaining >= meetDuration) {
        const transitionBudget = transitionDuration > 0
          ? Math.min(transitionDuration, Math.max(remaining - meetDuration, 0))
          : 0;
        if (transitionBudget > 0) {
          segments.push({
            type: 'transition',
            duration: transitionBudget,
            round: roundIndex,
            start: elapsed,
            end: elapsed + transitionBudget
          });
          elapsed += transitionBudget;
          remaining -= transitionBudget;
        }
        if (remaining < meetDuration) break;
        segments.push({
          type: 'meet',
          duration: meetDuration,
          round: roundIndex,
          start: elapsed,
          end: elapsed + meetDuration
        });
        elapsed += meetDuration;
        remaining -= meetDuration;
        roundIndex++;
      }
      return segments;
    }

    function renderTimelineSegments() {
      timelineSegments.innerHTML = '';
      timelineDots.innerHTML = '';
      if (!timelineSegmentsData.length || totalPlannedDuration <= 0) return;
      const total = totalPlannedDuration;
      timelineSegmentsData.forEach((segment) => {
        const seg = document.createElement('div');
        seg.className = `timeline-segment ${segment.type}`;
        seg.style.left = `${(segment.start / total) * 100}%`;
        seg.style.width = `${(segment.duration / total) * 100}%`;
        timelineSegments.appendChild(seg);

        const dot = document.createElement('div');
        dot.className = `timeline-dot ${segment.type}`;
        dot.style.left = `${(segment.start / total) * 100}%`;
        timelineDots.appendChild(dot);
      });
      const endDot = document.createElement('div');
      endDot.className = 'timeline-dot meet';
      endDot.style.left = '100%';
      timelineDots.appendChild(endDot);
    }

    function updateTimelineProgress() {
      const elapsed = Math.max(0, totalTimeInSeconds - Math.max(totalRemaining, 0));
      const denom = totalPlannedDuration || totalTimeInSeconds || 1;
      const pct = Math.min(1, elapsed / denom);
      timelineProgress.style.width = `${pct * 100}%`;
      if (timelineLabelStart) {
        timelineLabelStart.textContent = formatTime(Math.min(elapsed, denom));
      }
    }

    function setGroupsRevealed(revealed) {
      groupsRevealed = revealed;
      pairingContainer.querySelectorAll('.flip-card').forEach((card) => {
        card.classList.toggle('is-flipped', revealed);
      });
    }

    function updateActionMessage({ headline, subtext }) {
      if (typeof headline === 'string') actionHeadline.textContent = headline;
      if (typeof subtext === 'string') actionSubtext.textContent = subtext;
    }

    function setGroupsPanelCollapsed(collapsed) {
      groupsPanelCollapsed = collapsed;
      activityLayout.classList.toggle('groups-collapsed', collapsed);
      if (toggleGroupsPaneBtn) {
        toggleGroupsPaneBtn.setAttribute('aria-expanded', String(!collapsed));
        toggleGroupsPaneBtn.setAttribute('aria-label', collapsed ? 'Show groups' : 'Hide groups');
        toggleGroupsPaneBtn.title = collapsed ? 'Show groups' : 'Hide groups';
      }
    }

    function handleReveal() {
      if (groupsPanelCollapsed) setGroupsPanelCollapsed(false);
      if (groupsRevealed) return;
      setGroupsRevealed(true);
      revealGroupsBtn.disabled = true;
      revealGroupsBtn.classList.add('d-none');
      beginRoundBtn.classList.remove('d-none');
      beginRoundBtn.classList.add('btn-pulse');
      groupsHelperText.textContent = 'Students, find your partner!';
      updateActionMessage({
        headline: `Round ${nextRoundNumber}: Find your partner`,
        subtext: activeTransitionDuration > 0
          ? 'The countdown has started. Begin the round when everyone is ready.'
          : 'Begin the round when everyone is ready.'
      });
      if (activeTransitionDuration > 0) {
        paused = false;
        pauseResumeBtn.disabled = false;
        pauseResumeBtn.textContent = 'Pause';
        if (currentPhaseTime <= 10) {
          playSound('ten');
          transitionCountdownStarted = true;
        } else {
          transitionCountdownStarted = false;
        }
      }
      groupsRevealed = true;
    }

    // ---------- TIMER DRAWING -----------
    function drawTimer(percentage, color = '#28a745') {
      const dpr = window.devicePixelRatio || 1;
      const cardWidth = timerCard ? timerCard.clientWidth : 420;
      const sizeCSS = Math.max(280, Math.min(cardWidth * 0.78, 520));
      timerCanvas.width = sizeCSS * dpr;
      timerCanvas.height = sizeCSS * dpr;
      timerCanvas.style.width = sizeCSS + 'px';
      timerCanvas.style.height = sizeCSS + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      ctx.clearRect(0, 0, sizeCSS, sizeCSS);
      const cx = sizeCSS / 2;
      const cy = sizeCSS / 2;
      const radius = sizeCSS / 2 - 16;

      // background ring
      ctx.beginPath();
      ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = '#e9ecef';
      ctx.lineWidth = 16;
      ctx.stroke();

      // progress arc
      ctx.beginPath();
      const startAngle = -Math.PI / 2;
      const endAngle = startAngle + 2 * Math.PI * Math.max(Math.min(percentage, 1), 0);
      ctx.arc(cx, cy, radius, startAngle, endAngle);
      ctx.strokeStyle = color;
      ctx.lineCap = 'round';
      ctx.lineWidth = 16;
      ctx.stroke();
    }

    function setStatus(type) {
      if (type === 'transition') {
        statusPill.className = 'status-pill status-transition';
        statusPill.textContent = `Round ${nextRoundNumber}: Find your partner!`;
      } else {
        statusPill.className = 'status-pill status-meet';
        statusPill.textContent = `Round ${round}: Meet!`;
      }
    }

    // ---------- REPORT -----------
    function buildReport() {
      const roundsReport = document.getElementById('roundsReport');
      roundsReport.innerHTML = '';

      roundsHistory.forEach((groups, i) => {
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `<div class="fw-bold mb-1">Round ${i + 1}</div>
          ${groups.map((g) => g.join(' & ')).join('<br>')}`;
        roundsReport.appendChild(item);
      });

      // Individual summary
      const byStudent = {};
      students.forEach((s) => (byStudent[s] = new Set()));
      roundsHistory.forEach((groups) => {
        groups.forEach((g) => {
          g.forEach((s1) => g.forEach((s2) => s1 !== s2 && byStudent[s1].add(s2)));
        });
      });

      const individualReport = document.getElementById('individualReport');
      individualReport.innerHTML = '';
      Object.keys(byStudent)
        .sort((a, b) => a.localeCompare(b))
        .forEach((name) => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `<span class="fw-bold">${name}</span><span>${Array.from(byStudent[name]).join(', ') || '—'}</span>`;
          individualReport.appendChild(li);
        });
    }

    // ---------- HELPERS -----------
    function formatTime(sec) {
      const m = Math.floor(Math.max(sec, 0) / 60);
      const s = Math.max(sec, 0) % 60;
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    // ---------- EVENTS -----------
    startButton.addEventListener('click', initActivity);
    pauseResumeBtn.addEventListener('click', () => {
      if (pauseResumeBtn.disabled) return;
      paused = !paused;
      pauseResumeBtn.textContent = paused ? 'Resume' : 'Pause';
    });
    revealGroupsBtn.addEventListener('click', handleReveal);
    beginRoundBtn.addEventListener('click', () => {
      beginRoundBtn.classList.remove('btn-pulse');
      stopSound('ten');
      paused = false;
      beginMeetPhase();
    });
    regroupBtn.addEventListener('click', () => {
      const remaining = Math.max(totalRemaining, 0);
      if (remaining < groupTimeInSeconds) {
        endActivity();
        return;
      }
      stopSound('ten');
      stopSound('timeUp');
      prepareTransition();
    });
    if (toggleDigitsBtn) {
      toggleDigitsBtn.addEventListener('click', () => {
        timerDigitsVisible = !timerDigitsVisible;
        timerCard.classList.toggle('show-digits', timerDigitsVisible);
        toggleDigitsBtn.textContent = timerDigitsVisible ? 'Hide Digits' : 'Show Digits';
      });
    }
    if (toggleGroupsPaneBtn) {
      toggleGroupsPaneBtn.addEventListener('click', () => {
        const nextState = !groupsPanelCollapsed;
        setGroupsPanelCollapsed(nextState);
        if (!nextState) {
          activityLayout.classList.remove('timer-focus');
          activityLayout.classList.add('groups-focus');
        } else {
          activityLayout.classList.remove('groups-focus');
          activityLayout.classList.add('timer-focus');
        }
      });
    }
    endActivityBtn.addEventListener('click', () => endActivity());
    runAgainBtn.addEventListener('click', runAgain);

    saveClassButton.addEventListener('click', handleSaveClass);
    deleteClassButton.addEventListener('click', handleDeleteClass);
    addNewClassButton.addEventListener('click', handleAddNewClass);
    classDropdown.addEventListener('change', handleClassChange);

    // boot
    populateClassDropdown();
  </script>
</body>
</html>
