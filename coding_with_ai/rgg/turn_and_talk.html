<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Turn & Talk Facilitator ‚Äî Unified</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --primary: #c5eab2;
      --primary-light: #eafce2;
      --primary-bright: #b2ff8b;
      --primary-darker: #89be6d;
      --box-bg-color: #f4f3e8;
      --text: #1d1d1d;
      --muted: #6a6a6a;
      --radius-lg: 14px;
      --shadow-sm: 0 0.125rem 0.25rem rgba(0,0,0,.06);
      --shadow-lg: 0 1.2rem 3rem rgba(0,0,0,.12);
      --transition: .25s ease;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--box-bg-color);
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",sans-serif;
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .page {
      flex: 1;
      display: none;
      overflow-y: auto;
      padding: 1.5rem 1.5rem 5rem;
    }
    .page.active { display: block; }
    .setup-grid {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 1.5rem;
    }
    @media (max-width: 1000px) {
      .setup-grid { grid-template-columns: 1fr; }
    }
    .panel {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 1.2rem 1.25rem 1.4rem;
      box-shadow: var(--shadow-sm);
    }
    .panel h2 {
      margin: 0 0 .75rem;
      font-weight: 600;
      font-size: 1.05rem;
    }
    .muted { color: var(--muted); font-size: .9rem; }
    .source-toggle {
      display: flex;
      gap: .5rem;
      margin-bottom: 1rem;
    }
    .source-pill {
      flex: 1;
      border: 1px solid rgba(0,0,0,.08);
      background: #fff;
      border-radius: 999px;
      padding: .5rem .75rem;
      text-align: center;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }
    .source-pill.active {
      background: var(--primary);
      border-color: transparent;
    }
    .card-grid {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .cat-card, .level-card {
      background: #fff;
      border: 2px solid transparent;
      border-radius: 1rem;
      padding: 1rem;
      flex: 1 0 150px;
      min-height: 120px;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }
    .cat-card.active, .level-card.active {
      border-color: var(--primary-darker);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .cat-card h3, .level-card h3 { margin: .25rem 0 .5rem; }
    .button-row {
      display: flex;
      gap: .5rem;
      margin-top: 1rem;
    }
    .prompt-preview {
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 1rem;
      padding: .9rem 1rem;
      font-size: 1.05rem;
      line-height: 1.55;
      color: #1f331d;
      box-shadow: var(--shadow-sm);
    }
    .prompt-preview::before {
      content: attr(data-label);
      display: block;
      font-size: .7rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: .35rem;
    }
    .time-hint {
      font-size: .8rem;
      margin: .25rem 0 0;
      color: var(--muted);
    }
    .btn {
      border: none;
      background: var(--primary);
      color: #000;
      border-radius: .8rem;
      padding: .5rem 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    .btn:hover { filter: brightness(.97); }
    .btn-secondary {
      background: #f1f1f1;
      color: #000;
    }
    .full { width: 100%; }
    input[type="number"], select, textarea {
      width: 100%;
      border-radius: .6rem;
      border: 1px solid rgba(0,0,0,.12);
      padding: .4rem .5rem;
      font-size: 1rem;
      background: #fff;
    }
    textarea { resize: vertical; min-height: 80px; }
    #display-view {
      background: radial-gradient(circle at top, rgba(197,234,178,.3) 0%, rgba(244,243,232,1) 48%, rgba(244,243,232,1) 100%);
      position: relative;
    }
    .display-phase {
      display: none;
      height: 100%;
      text-align: center;
      padding: 3rem 1.5rem 5rem;
      max-width: 1100px;
      margin: 0 auto;
    }
    .display-phase.active { display: flex; flex-direction: column; justify-content: center; gap: 1.75rem; }
    .phase-title {
      font-size: clamp(2.2rem, 4vw, 3rem);
      margin: 0;
      color: #2f4f2f;
      font-weight: 700;
    }
    .prompt-main {
      font-size: clamp(2.1rem, 3.6vw, 3.1rem);
      font-weight: 600;
      line-height: 1.3;
    }
    .prompt-secondary {
      font-size: clamp(1.1rem, 2.4vw, 1.5rem);
      color: #234;
      opacity: .85;
    }
    #group-prompt {
      font-size: clamp(1.4rem, 3vw, 2.1rem);
      font-weight: 600;
    }
    #wrap-prompt {
      font-size: clamp(1.2rem, 2.6vw, 1.8rem);
      font-weight: 500;
    }
    .twist {
      background: rgba(137,190,109,.12);
      border: 1px solid rgba(137,190,109,.3);
      padding: 1rem 1.2rem;
      border-radius: 1rem;
      font-weight: 500;
      max-width: 720px;
      margin: 0 auto;
      opacity: 0;
      transition: .5s ease;
      font-size: clamp(1.15rem, 2.3vw, 1.7rem);
      line-height: 1.55;
    }
    .twist.visible { opacity: 1; }
    #group-bonus {
      display: none;
      background: rgba(178,255,139,.2);
      border-color: rgba(137,190,109,.6);
    }
    #group-bonus.visible { display: block; }
    .timer-big {
      font-size: clamp(4rem, 7vw, 6rem);
      font-weight: 700;
      letter-spacing: .03em;
    }
    .timer-big.warning {
      color: #c03030;
    }
    .progress-bar-wrap {
      height: 40px;
      background: rgba(0,0,0,.04);
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #89be6d 0%, #c5eab2 100%);
      transition: width 1s linear;
    }
    .top-right {
      position: fixed;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
      z-index: 100;
    }
    .wrap-notes {
      width: min(850px,100%);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .wrap-notes textarea {
      min-height: 200px;
      font-size: 1rem;
      background: rgba(255,255,255,.7);
    }
    .phase-track {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin: 1.5rem auto 0;
      width: min(680px, 90%);
      flex-wrap: wrap;
    }
    .phase-track-step {
      position: relative;
      border: none;
      background: #fff;
      color: #234;
      font-weight: 600;
      padding: .5rem 1.1rem;
      border-radius: 999px;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: var(--transition);
    }
    .phase-track-step::after {
      content: "";
      position: absolute;
      top: 50%;
      right: -2.2rem;
      width: 2rem;
      height: 3px;
      transform: translateY(-50%);
      background: rgba(137,190,109,.35);
    }
    .phase-track-step:last-child::after { display: none; }
    .phase-track-step.active {
      background: var(--primary);
      color: #0f2910;
      box-shadow: var(--shadow-lg);
    }
    .phase-track-step.completed::after {
      background: var(--primary-darker);
    }
    .phase-track-step.completed {
      background: rgba(197,234,178,0.55);
    }
    .phase-track-step:hover { filter: brightness(.97); }
    @media (max-width: 520px) {
      .phase-track { gap: .8rem; }
      .phase-track-step::after { display: none; }
    }
    .small-btn {
      padding: .35rem .65rem;
      border-radius: .5rem;
    }
    /* NEXT BUTTON */
    #advance-btn {
      position: fixed;
      bottom: 4.5rem;
      right: 1.25rem;
      background: #89be6d;
      color: #000;
      font-size: 1.05rem;
      padding: .75rem 1.1rem;
      border-radius: 999px;
      box-shadow: 0 14px 28px rgba(0,0,0,.18);
      display: none;
      z-index: 101;
    }
    #advance-btn:hover { filter: brightness(.95); }
    @media (max-width: 650px) {
      #advance-btn { bottom: 5.4rem; right: .7rem; }
    }

    /* SECRET MODAL */
    #share-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.28);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
    }
    #share-modal {
      background: #fff;
      width: min(540px,90vw);
      border-radius: 1rem;
      box-shadow: 0 20px 40px rgba(0,0,0,.14);
      padding: 1.25rem 1.4rem 1.2rem;
    }
    #share-modal h3 { margin-top: 0; }
    #share-url {
      width: 100%;
      border: 1px solid rgba(0,0,0,.15);
      border-radius: .6rem;
      padding: .35rem .5rem;
      font-family: ui-monospace, SFMono-Regular, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .8rem;
      margin-bottom: .5rem;
    }
  </style>
</head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N67EP99YJK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-N67EP99YJK');
</script>
<body>
  <!-- SETUP VIEW -->
  <div id="setup-view" class="page active">
    <div class="setup-grid">
      <!-- LEFT: PROMPT ENGINE -->
      <div class="panel">
        <h2>1. Choose Prompt Source</h2>
        <p class="muted">Pick how you want to feed the activity with prompts.</p>
        <div class="source-toggle">
          <div class="source-pill active" data-source="leveled">Choose a Category and Level</div>
          <div class="source-pill" data-source="flat">Pick from a List</div>
        </div>

        <!-- LEVELED ENGINE -->
        <div id="leveled-config">
          <p class="muted" style="margin-bottom:.5rem">Step A ‚Äî category</p>
          <div class="card-grid" id="category-cards">
            <div class="cat-card active" data-cat="Interests"><h3>Interests</h3><p class="muted">Hobbies, media, culture.</p></div>
            <div class="cat-card" data-cat="Feelings"><h3>Feelings</h3><p class="muted">SEL, perspective.</p></div>
            <div class="cat-card" data-cat="Experiences"><h3>Experiences</h3><p class="muted">Stories, travel, family.</p></div>
          </div>
          <p class="muted" style="margin:.9rem 0 .5rem">Step B ‚Äî complexity</p>
          <div class="card-grid" id="level-cards">
            <div class="level-card active" data-lvl="1"><h3>Level 1</h3><p class="muted">Low stakes, rapport.</p></div>
            <div class="level-card" data-lvl="2"><h3>Level 2</h3><p class="muted">Values, dilemmas.</p></div>
            <div class="level-card" data-lvl="3"><h3>Level 3</h3><p class="muted">Connect to a global issue.</p></div>
          </div>
          <button class="btn" id="leveled-next-btn" style="margin-top:.8rem;">Next in deck</button>
          <div id="leveled-current" class="prompt-preview" data-label="Current prompt"></div>
        </div>

        <!-- FLAT ENGINE -->
        <div id="flat-config" style="display:none; margin-top:1rem;">
            <label class="muted" for="flat-select">Prompt list</label>
            <select id="flat-select"></select>
            <div class="button-row" style="margin-top:.6rem;">
              <button class="btn btn-secondary" id="flat-random-btn">Random</button>
              <button class="btn btn-secondary" id="flat-star-btn">‚≠ê Star</button>
            </div>
            <p class="muted" style="margin-top:1rem">Add your own:</p>
            <textarea id="flat-custom" placeholder="Type a prompt students will discuss..."></textarea>
            <button class="btn full" id="flat-add-btn" style="margin-top:.5rem;">Add & select</button>
            <div id="flat-current" class="prompt-preview" data-label="Selected prompt" style="display:none; margin-top:1rem;"></div>
        </div>
      </div>

      <!-- RIGHT: TIMERS & START -->
      <div class="panel">
        <h2>2. Timing & Activity</h2>
        
        <label>Individual reflection (seconds)</label>
        <input type="number" id="indiv-seconds" value="60" min="10" step="5" />
        <p class="muted time-hint" id="indiv-time-hint"></p>
        <label style="margin-top:.7rem;">Group discussion (seconds)</label>
        <input type="number" id="group-seconds" value="180" min="20" step="5" />
        <p class="muted time-hint" id="group-time-hint"></p>
        
        <button class="btn full" id="start-activity" style="margin-top:1rem;">Start & Show Display ‚Üí</button>
        
      </div>
    </div>
  </div>

  <!-- DISPLAY VIEW -->
  <div id="display-view" class="page">
    <div class="top-right">
      <button class="btn btn-secondary small-btn" id="mute-btn" title="Toggle sound">üîà</button>
      <button class="btn btn-secondary small-btn" id="back-to-setup-btn" style="display:none;">‚Üê Back</button>
    </div>
    <div class="phase-track">
      <button type="button" class="phase-track-step active" data-phase="individual">Think</button>
      <button type="button" class="phase-track-step" data-phase="group">Discuss</button>
      <button type="button" class="phase-track-step" data-phase="wrap">Share</button>
    </div>

    <!-- INDIVIDUAL -->
    <div id="phase-individual" class="display-phase active">
      <h2 class="phase-title">Think on your own...</h2>
      <div class="prompt-main" id="indiv-prompt">Prompt will appear here.</div>
      <div class="timer-big" id="indiv-timer">00:00</div>
      <div class="twist" id="indiv-twist"><strong>Twist:</strong> add another example or explain why this matters.</div>
    </div>

    <!-- GROUP -->
    <div id="phase-group" class="display-phase">
      <h2 class="phase-title">Turn & Talk!</h2>
      <div class="prompt-secondary" id="group-prompt">Prompt will stay visible here.</div>
      <div class="timer-big" id="group-timer">00:00</div>
      <div class="twist" id="group-twist"><strong>Deepener:</strong> Find one thing you all agree on.</div>
      <div class="twist" id="group-bonus"></div>
    </div>

    <!-- WRAP -->
    <div id="phase-wrap" class="display-phase">
      <div class="wrap-notes">
        <h2 class="phase-title">Time‚Äôs up ‚Äî let‚Äôs share.</h2>
        <p class="prompt-secondary" id="wrap-prompt"></p>
        <textarea id="wrap-notes" placeholder="What did students say that was smart, surprising, or worth revisiting?"></textarea>
        <button class="btn btn-secondary" id="copy-notes-btn" style="align-self:flex-start;">Copy notes</button>
      </div>
    </div>

    <div class="progress-bar-wrap" id="progress-wrap" style="display:none;">
      <div class="progress-bar" id="progress-bar"></div>
    </div>

    <!-- BIG NEXT -->
    <button class="btn" id="advance-btn">Next ‚Üí</button>
  </div>

  <!-- SECRET SHARE MODAL -->
  <div id="share-modal-backdrop">
    <div id="share-modal">
      <h3>Share this activity</h3>
      <p class="muted" style="margin-bottom:.6rem;">This link encodes source, prompt, and timers.</p>
      <input id="share-url" readonly />
      <div class="button-row">
        <button class="btn" id="share-copy-btn">Copy</button>
        <button class="btn btn-secondary" id="share-close-btn">Close</button>
      </div>
      <p class="muted" style="margin-top:.5rem; font-size:.7rem;">(open with no <code>?p=</code> to go back to normal)</p>
    </div>
  </div>

  <script>
    // ====== PROMPT DATA ======
    const leveledPrompts = {
      "Interests": {
        1: [
          { q: "If you could only listen to one album for a month, which would it be and why?", h: "Pick something you don‚Äôt get tired of, or that connects to a memory." },
          { q: "What's a movie or TV show you think everyone should watch?", h: "It doesn‚Äôt have to be a classic ‚Äî just meaningful or fun." },
          { q: "Describe a hobby you love and what makes it so special to you.", h: "Gaming, sports, drawing ‚Äî tell the story behind it." },
          { q: "What is one food you could never get tired of eating?", h: "Think comfort food or celebration food." },
          { q: "If you could have any fictional character as a friend, who would you choose?", h: "Think about personality, not power." }
        ],
        2: [
          { q: "Think about a book, movie, or song that taught you an important lesson. What was it?", h: "What did it change in how you think?" },
          { q: "How do your favorite hobbies or interests shape the way you see the world?", h: "Does your hobby make you notice things other people don‚Äôt?" },
          { q: "How has a hobby or interest helped you overcome a challenge?", h: "Tell the mini-story of that challenge." },
          { q: "What‚Äôs something you love that most adults don‚Äôt understand yet?", h: "Explain what makes it awesome." },
          { q: "If you started a club for one of your interests, what would the first meeting look like?", h: "Who shows up and what do you do?" }
        ],
        3: [
          { q: "How could your favorite hobby bring people from different backgrounds together?", h: "Imagine it being used for a community goal." },
          { q: "If you made a movie about a global issue, what message would it send?", h: "Think feeling + action." },
          { q: "Does the media we love have a responsibility to show different cultures? Why?", h: "Connect representation ‚Üí belonging." },
          { q: "How can your favorite interest inspire others to take action on an issue?", h: "Connect your hobby to a real problem." },
          { q: "If you shared your interest with leaders worldwide, what would you teach first?", h: "Show the link between the interest and global change." }
        ]
      },
      "Feelings": {
        1: [
          { q: "Describe a time you felt proud of something small.", h: "What made it feel big to you?" },
          { q: "What is something simple that always makes you calm?", h: "Think sensory stuff: smells, music, places." },
          { q: "What does 'courage' look like in everyday life?", h: "Small risks count." },
          { q: "What song matches your mood today and why?", h: "Connect the lyrics or sound to your feeling." },
          { q: "When do you feel most confident during the school day?", h: "Describe the moment or routine." }
        ],
        2: [
          { q: "Think about a time you had to apologize. What made it hard or easy?", h: "Focus on the feeling after you apologized." },
          { q: "Describe a situation where you felt misunderstood. How did you handle it?", h: "What would you do differently now?" },
          { q: "Describe a time you helped a friend through a tough feeling.", h: "What did you say or do?" },
          { q: "How do you reset after a stressful day?", h: "Share the steps you take to feel better." },
          { q: "When have you had to balance your feelings with someone else's?", h: "What compromise did you make?" }
        ],
        3: [
          { q: "Tell a story about feeling empathy ‚Äî how does that scale to bigger issues?", h: "One person ‚Üí whole group ‚Üí world." },
          { q: "Describe the feeling of fairness. How does that connect to global issues?", h: "Use your own life as the example." },
          { q: "How can listening to emotions make a community fairer?", h: "Start from a local example." },
          { q: "When people share feelings online, how can it spark real change?", h: "Think about movements you‚Äôve noticed." },
          { q: "How might empathy help solve a global challenge you care about?", h: "Pick an issue and connect it to a feeling." }
        ]
      },
      "Experiences": {
        1: [
          { q: "What is one of your favorite family or holiday memories?", h: "Add what you heard, saw, smelled." },
          { q: "If you could relive one day, which would it be and why?", h: "Pick a specific day, not a whole year." },
          { q: "What routine do you secretly enjoy?", h: "Walk us through the steps." },
          { q: "Tell about a small adventure you had close to home.", h: "What tiny details made it memorable?" },
          { q: "What experience made you laugh way harder than expected?", h: "Give the quick play-by-play." }
        ],
        2: [
          { q: "Describe a time you took a small risk that paid off.", h: "What did you learn about trying new things?" },
          { q: "Share an experience where you collaborated to achieve a goal.", h: "How did the group help you?" },
          { q: "Share a time you tried something new with friends or family.", h: "What surprised you most?" },
          { q: "Describe a project where planning ahead mattered.", h: "How did teamwork or preparation help?" },
          { q: "When did you learn from a mistake during an activity?", h: "What did you do differently afterward?" }
        ],
        3: [
          { q: "Think of a time you had limited resources. How does that relate to sustainability?", h: "What did you do instead of buying something new?" },
          { q: "Share a story about working in a team. How does that connect to global cooperation?", h: "Your team = mini version of countries." },
          { q: "How can a local experience teach you about a global issue?", h: "Zoom out from your personal story." },
          { q: "Describe a moment when you saw cooperation in action.", h: "Connect it to how communities or countries work together." },
          { q: "What everyday experience shows why sustainability matters?", h: "Link your story to using resources wisely." }
        ]
      }
    };

    const baseFlatPrompts = [
      "If you could have any superpower but for something boring, what would it be?",
      "What's a food you love that almost everyone else hates?",
      "If animals could talk, which would be the rudest?",
      "Invent a new holiday ‚Äî how do we celebrate?",
      "What‚Äôs the best smell in the world?",
      "Lightning round: explain your weekend in 10 words.",
      "If you could interview anyone in history, who and what‚Äôs the first question?",
      "What‚Äôs a small thing that made your week better?"
    ];
    const flatStorageKey = "ttf_custom_prompts_v3";
    const flatFavKey = "ttf_fav_prompts_v3";

    // ====== STATE ======
    let currentSource = "leveled";
    let currentCategory = "Interests";
    let currentLevel = 1;
    let currentLeveledDeck = [];
    let currentPromptObj = null;

    let flatPrompts = [];
    let flatFavorites = [];
    let lastFlatSelection = "";
    let lastLeveledPrompt = null;

    let currentPhase = "individual";
    let timerInterval = null;
    const KISMET_CHANCE = 0.15;
    const BONUS_SECONDS = 30;
    const WARNING_SECONDS = 10;
    let audioCtx = null;
    let muted = false;

    // ====== DOM ======
    const setupView = document.getElementById("setup-view");
    const displayView = document.getElementById("display-view");
    const sourcePills = document.querySelectorAll(".source-pill");
    const leveledConfig = document.getElementById("leveled-config");
    const flatConfig = document.getElementById("flat-config");
    const catCards = document.querySelectorAll(".cat-card");
    const levelCards = document.querySelectorAll(".level-card");
    const leveledNextBtn = document.getElementById("leveled-next-btn");
    const leveledCurrent = document.getElementById("leveled-current");
    const flatSelect = document.getElementById("flat-select");
    const flatCurrent = document.getElementById("flat-current");
    const flatRandomBtn = document.getElementById("flat-random-btn");
    const flatStarBtn = document.getElementById("flat-star-btn");
    const flatCustom = document.getElementById("flat-custom");
    const flatAddBtn = document.getElementById("flat-add-btn");
    const indivSecondsInput = document.getElementById("indiv-seconds");
    const groupSecondsInput = document.getElementById("group-seconds");
    const startActivityBtn = document.getElementById("start-activity");
    const indivTimeHint = document.getElementById("indiv-time-hint");
    const groupTimeHint = document.getElementById("group-time-hint");

    const indivPhase = document.getElementById("phase-individual");
    const groupPhase = document.getElementById("phase-group");
    const wrapPhase = document.getElementById("phase-wrap");
    const indivPromptEl = document.getElementById("indiv-prompt");
    const groupPromptEl = document.getElementById("group-prompt");
    const wrapPromptEl = document.getElementById("wrap-prompt");
    const indivTimerEl = document.getElementById("indiv-timer");
    const groupTimerEl = document.getElementById("group-timer");
    const indivTwistEl = document.getElementById("indiv-twist");
    const groupTwistEl = document.getElementById("group-twist");
    const groupBonusEl = document.getElementById("group-bonus");
    const progressWrap = document.getElementById("progress-wrap");
    const progressBar = document.getElementById("progress-bar");
    const advanceBtn = document.getElementById("advance-btn");
    const backToSetupBtn = document.getElementById("back-to-setup-btn");
    const copyNotesBtn = document.getElementById("copy-notes-btn");
    const wrapNotesEl = document.getElementById("wrap-notes");
    const muteBtn = document.getElementById("mute-btn");
    const phaseTrackButtons = document.querySelectorAll(".phase-track-step");
    const phaseOrder = ["individual","group","wrap"];

    // secret modal dom
    const shareBackdrop = document.getElementById("share-modal-backdrop");
    const shareUrlInput = document.getElementById("share-url");
    const shareCopyBtn = document.getElementById("share-copy-btn");
    const shareCloseBtn = document.getElementById("share-close-btn");

    function showSetupView() {
      setupView.classList.add("active");
      displayView.classList.remove("active");
      backToSetupBtn.style.display = "none";
      updatePhaseTrack("individual");
    }
    function showDisplayView() {
      setupView.classList.remove("active");
      displayView.classList.add("active");
      backToSetupBtn.style.display = "inline-flex";
      updatePhaseTrack("individual");
    }

    // ====== AUDIO ======
    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function playTone(freq = 660, dur = 0.25) {
      if (muted) return;
      initAudio();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = freq;
      gain.gain.value = 0.3;
      osc.start();
      osc.stop(audioCtx.currentTime + dur);
    }

    function updatePhaseTrack(activePhase) {
      const activeIndex = phaseOrder.indexOf(activePhase);
      phaseTrackButtons.forEach(btn => {
        const targetPhase = btn.dataset.phase;
        const idx = phaseOrder.indexOf(targetPhase);
        btn.classList.toggle("active", idx === activeIndex);
        btn.classList.toggle("completed", idx !== -1 && idx < activeIndex);
      });
    }

    // ====== FLAT PROMPTS ======
    function loadFlatPrompts() {
      const stored = JSON.parse(localStorage.getItem(flatStorageKey) || "[]");
      const favs = JSON.parse(localStorage.getItem(flatFavKey) || "[]");
      flatPrompts = [...baseFlatPrompts, ...stored];
      flatFavorites = favs;
      renderFlatSelect();
    }
    // filter out base prompts when saving (fixed)
    function saveFlatCustom(fullList) {
      const customs = fullList.filter(p => !baseFlatPrompts.includes(p));
      localStorage.setItem(flatStorageKey, JSON.stringify(customs));
    }
    function renderFlatSelect() {
      const previous = lastFlatSelection || flatSelect.value || "";
      flatSelect.innerHTML = "";
      const sorted = [...flatPrompts].sort((a,b) => {
        const af = flatFavorites.includes(a);
        const bf = flatFavorites.includes(b);
        if (af && !bf) return -1;
        if (!af && bf) return 1;
        return 0;
      });
      sorted.forEach((p,idx) => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = (flatFavorites.includes(p) ? "‚≠ê " : "") + (p.length > 80 ? p.substring(0,80) + "..." : p);
        flatSelect.appendChild(opt);
      });
      if (sorted.length > 0) {
        const selection = sorted.includes(previous) ? previous : sorted[0];
        flatSelect.value = selection;
        lastFlatSelection = selection;
      } else {
        flatSelect.value = "";
        lastFlatSelection = "";
      }
      updateFlatStarButton();
      refreshFlatPreview();
    }
    function updateFlatStarButton() {
      const selPrompt = flatSelect.value;
      if (!selPrompt) return;
      if (flatFavorites.includes(selPrompt)) {
        flatStarBtn.textContent = "‚≠ê Un-star";
      } else {
        flatStarBtn.textContent = "‚≠ê Star";
      }
    }
    function refreshFlatPreview() {
      if (!flatCurrent) return;
      const val = flatSelect.value;
      if (val) {
        flatCurrent.style.display = "block";
        flatCurrent.textContent = val;
      } else {
        flatCurrent.style.display = "none";
        flatCurrent.textContent = "";
      }
    }
    function updateTimeHints() {
      if (indivTimeHint) {
        const secs = Math.max(parseInt(indivSecondsInput.value, 10) || 0, 0);
        indivTimeHint.textContent = "= " + formatTime(secs) + " (" + secs + "s)";
      }
      if (groupTimeHint) {
        const secs = Math.max(parseInt(groupSecondsInput.value, 10) || 0, 0);
        groupTimeHint.textContent = "= " + formatTime(secs) + " (" + secs + "s)";
      }
    }

    // ====== LEVELED HELPERS ======
    function rebuildLeveledDeck() {
      const arr = (leveledPrompts[currentCategory] && leveledPrompts[currentCategory][currentLevel]) || [];
      currentLeveledDeck = arr.slice().sort(() => Math.random() - 0.5);
    }
    function pickLeveledPrompt() {
      if (currentLeveledDeck.length === 0) rebuildLeveledDeck();
      const p = currentLeveledDeck.pop();
      currentPromptObj = { ...p, source: "leveled" };
      leveledCurrent.textContent = currentPromptObj.q;
      lastLeveledPrompt = { ...currentPromptObj };
      return currentPromptObj;
    }

    // ====== PHASES ======
    function showDisplayPhase(phase) {
      currentPhase = phase;
      indivPhase.classList.remove("active");
      groupPhase.classList.remove("active");
      wrapPhase.classList.remove("active");
      if (phase === "individual") indivPhase.classList.add("active");
      if (phase === "group") groupPhase.classList.add("active");
      if (phase === "wrap") wrapPhase.classList.add("active");

      updatePhaseTrack(phase);
      advanceBtn.style.display = (phase === "individual" || phase === "group") ? "inline-block" : "none";
      progressWrap.style.display = (phase !== "wrap") ? "block" : "none";
    }

    function startProgress(seconds) {
      progressBar.style.transition = "none";
      progressBar.style.width = "0%";
      setTimeout(() => {
        progressBar.style.transition = `width ${seconds}s linear`;
        progressBar.style.width = "100%";
      }, 50);
    }

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return m + ":" + String(s).padStart(2, "0");
    }

    const groupDeepeners = [
      "Find one thing you all agree on.",
      "Connect this to something we learned last week.",
      "Switch speakers: new person summarizes the group.",
      "Argue the opposite side ‚Äî just for practice.",
      "How would a younger student answer this?",
      "What‚Äôs the real-world version of this?"
    ];
    const bonusChallenges = [
      "Summarize your idea in ONE word.",
      "Point to the person with the most unusual answer.",
      "Vote: serious answer vs silly answer.",
      "Teach your idea in 15 seconds to an imaginary student.",
      "Stand up if your group changed your mind."
    ];

    function runIndividualPhase() {
      const total = parseInt(indivSecondsInput.value) || 60;
      showDisplayPhase("individual");
      indivTwistEl.classList.remove("visible");
      indivTimerEl.classList.remove("warning");
      indivPromptEl.textContent = currentPromptObj ? currentPromptObj.q : "No prompt selected.";
      startTimer(total, {
        onTick: (left) => {
          indivTimerEl.textContent = formatTime(Math.max(left, 0));
        },
        onEnd: () => {
          indivTimerEl.classList.remove("warning");
          playTone(880,0.25);
          runGroupPhase();
        },
        onHalfway: () => {
          if (currentPromptObj && currentPromptObj.h) {
            indivTwistEl.innerHTML = "<strong>Twist:</strong> " + currentPromptObj.h;
          } else {
            indivTwistEl.innerHTML = "<strong>Twist:</strong> Add an example or a ‚Äòwhy.‚Äô";
          }
          indivTwistEl.classList.add("visible");
        },
        onWarning: () => {
          indivTimerEl.classList.add("warning");
          playTone(440,0.18);
        }
      });
    }

    function runGroupPhase() {
      const total = parseInt(groupSecondsInput.value) || 180;
      showDisplayPhase("group");
      groupPromptEl.textContent = currentPromptObj ? currentPromptObj.q : "Discuss the previous idea.";
      groupTwistEl.classList.remove("visible");
      groupBonusEl.classList.remove("visible");
      groupBonusEl.innerHTML = "";
      groupTimerEl.classList.remove("warning");

      const bonusPossible = total > BONUS_SECONDS;
      const bonusActivated = bonusPossible && Math.random() < KISMET_CHANCE;
      const bonusText = bonusActivated ? bonusChallenges[Math.floor(Math.random() * bonusChallenges.length)] : "";
      let bonusShown = false;

      startTimer(total, {
        onTick: (left) => {
          groupTimerEl.textContent = formatTime(Math.max(left, 0));
          if (bonusActivated && !bonusShown && left <= BONUS_SECONDS) {
            bonusShown = true;
            groupTwistEl.classList.remove("visible");
            groupBonusEl.innerHTML = "<strong>Bonus:</strong> " + bonusText;
            groupBonusEl.classList.add("visible");
          }
        },
        onEnd: () => {
          groupTimerEl.classList.remove("warning");
          playTone(660,0.25);
          runWrapPhase();
        },
        onHalfway: () => {
          groupTwistEl.innerHTML = "<strong>Deepener:</strong> " + groupDeepeners[Math.floor(Math.random() * groupDeepeners.length)];
          groupTwistEl.classList.add("visible");
        },
        onWarning: () => {
          groupTimerEl.classList.add("warning");
          playTone(440,0.18);
        }
      });
    }

    function runWrapPhase() {
      showDisplayPhase("wrap");
      wrapPromptEl.textContent = currentPromptObj ? currentPromptObj.q : "";
      indivTimerEl.classList.remove("warning");
      groupTimerEl.classList.remove("warning");
      groupBonusEl.classList.remove("visible");
      groupBonusEl.innerHTML = "";
      clearTimer();
      progressBar.style.width = "0%";
    }

    function startTimer(totalSeconds, { onTick, onEnd, onHalfway, onWarning } = {}) {
      clearTimer();
      startProgress(totalSeconds);
      let secs = totalSeconds;
      if (onTick) onTick(secs);
      const halfway = Math.floor(totalSeconds / 2);
      const warningAt = totalSeconds > WARNING_SECONDS ? WARNING_SECONDS : null;
      let warningSent = false;
      timerInterval = setInterval(() => {
        secs--;
        if (onTick) onTick(secs);
        if (!warningSent && warningAt !== null && secs === warningAt) {
          warningSent = true;
          if (onWarning) onWarning();
        }
        if (secs === halfway && onHalfway) onHalfway();
        if (secs <= 0) {
          clearTimer();
          onEnd && onEnd();
        }
      }, 1000);
    }
    function clearTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }

    // ====== URL ENCODE/DECODE ======
    function encodeStateToURL() {
      // short keys to keep it tight
      const state = {};
      // source: 'l' or 'f'
      state.s = currentSource === "leveled" ? "l" : "f";
      // timers
      state.it = parseInt(indivSecondsInput.value) || 60;
      state.gt = parseInt(groupSecondsInput.value) || 180;

      if (currentSource === "leveled") {
        // category + level + current prompt text (so you can override deck)
        state.c = currentCategory;   // "Interests"
        state.lvl = currentLevel;    // 1,2,3
        if (currentPromptObj && currentPromptObj.source === "leveled" && currentPromptObj.q) {
          state.p = currentPromptObj.q;
          if (currentPromptObj.h) state.h = currentPromptObj.h;
        }
      } else {
        // flat: just capture text
        let selectedFlat = null;
        if (currentPromptObj && currentPromptObj.source === "flat" && currentPromptObj.q) {
          selectedFlat = currentPromptObj.q;
        } else if (flatSelect.value) {
          selectedFlat = flatSelect.value;
        }
        if (selectedFlat) {
          state.p = selectedFlat;
        }
      }

      const json = JSON.stringify(state);
      const b64 = btoa(encodeURIComponent(json));
      const base = window.location.origin + window.location.pathname;
      return base + "?p=" + b64;
    }

    function tryLoadStateFromURL() {
      const params = new URLSearchParams(window.location.search);
      const p = params.get("p");
      if (!p) return;
      try {
        const json = decodeURIComponent(atob(p));
        const state = JSON.parse(json);
        // source
        if (state.s === "l") {
          currentSource = "leveled";
          sourcePills.forEach(p => p.classList.remove("active"));
          document.querySelector('.source-pill[data-source="leveled"]').classList.add("active");
          leveledConfig.style.display = "block";
          flatConfig.style.display = "none";

          if (state.c) {
            currentCategory = state.c;
            catCards.forEach(c => {
              c.classList.toggle("active", c.dataset.cat === currentCategory);
            });
          }
          if (state.lvl) {
            currentLevel = parseInt(state.lvl);
            levelCards.forEach(c => {
              c.classList.toggle("active", parseInt(c.dataset.lvl) === currentLevel);
            });
          }
          rebuildLeveledDeck();
          pickLeveledPrompt();

          // override with explicit prompt if present
          if (state.p) {
            currentPromptObj = { q: state.p, h: state.h || "", source: "leveled" };
            leveledCurrent.textContent = state.p;
            lastLeveledPrompt = { ...currentPromptObj };
          }
        } else if (state.s === "f") {
          currentSource = "flat";
          sourcePills.forEach(p => p.classList.remove("active"));
          document.querySelector('.source-pill[data-source="flat"]').classList.add("active");
          leveledConfig.style.display = "none";
          flatConfig.style.display = "block";

          if (state.p) {
            // ensure it's in list
            if (!flatPrompts.includes(state.p)) {
              flatPrompts.push(state.p);
              saveFlatCustom(flatPrompts);
              renderFlatSelect();
            }
            flatSelect.value = state.p;
            updateFlatStarButton();
            currentPromptObj = { q: state.p, h: "", source: "flat" };
            lastFlatSelection = state.p;
            refreshFlatPreview();
          }
        }

        if (typeof state.it === "number") indivSecondsInput.value = state.it;
        if (typeof state.gt === "number") groupSecondsInput.value = state.gt;
        updateTimeHints();
      } catch (e) {
        console.warn("could not decode shared state", e);
      }
    }

    function legacyCopy(text, preferredField) {
      if (typeof document.execCommand !== "function") return false;
      if (preferredField) {
        const previousReadOnly = preferredField.hasAttribute("readonly");
        if (previousReadOnly) preferredField.removeAttribute("readonly");
        preferredField.focus();
        preferredField.select();
        preferredField.setSelectionRange(0, text.length);
        let success = false;
        try {
          success = document.execCommand("copy");
        } catch (err) {
          success = false;
        }
        if (previousReadOnly) preferredField.setAttribute("readonly", "");
        if (success) return true;
      }
      const temp = document.createElement("textarea");
      temp.value = text;
      temp.setAttribute("readonly", "");
      temp.style.position = "fixed";
      temp.style.top = "-9999px";
      document.body.appendChild(temp);
      temp.focus();
      temp.select();
      let success = false;
      try {
        success = document.execCommand("copy");
      } catch (err) {
        success = false;
      }
      document.body.removeChild(temp);
      return success;
    }

    function copyTextToClipboard(text, preferredField) {
      if (!text) return Promise.resolve(false);
      const legacyResult = legacyCopy(text, preferredField);
      if (legacyResult) return Promise.resolve(true);
      if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
        return navigator.clipboard.writeText(text).then(() => true).catch(() => false);
      }
      return Promise.resolve(false);
    }

    function openShareModal() {
      const url = encodeStateToURL();
      shareUrlInput.value = url;
      shareBackdrop.style.display = "flex";
      shareUrlInput.select();
    }
    function closeShareModal() {
      shareBackdrop.style.display = "none";
    }

    // ====== EVENTS ======
    phaseTrackButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        if (!displayView.classList.contains("active")) return;
        const target = btn.dataset.phase;
        if (target === currentPhase) return;
        clearTimer();
        if (target === "individual") runIndividualPhase();
        else if (target === "group") runGroupPhase();
        else if (target === "wrap") runWrapPhase();
      });
    });

    sourcePills.forEach(pill => {
      pill.addEventListener("click", () => {
        const nextSource = pill.dataset.source;
        if (currentSource === nextSource) return;
        const previousSource = currentSource;
        currentSource = nextSource;
        sourcePills.forEach(p => p.classList.remove("active"));
        pill.classList.add("active");
        if (previousSource === "flat") {
          lastFlatSelection = flatSelect.value || lastFlatSelection;
        } else if (previousSource === "leveled" && currentPromptObj && currentPromptObj.source === "leveled") {
          lastLeveledPrompt = { ...currentPromptObj };
        }
        if (currentSource === "leveled") {
          leveledConfig.style.display = "block";
          flatConfig.style.display = "none";
          if (lastLeveledPrompt) {
            currentPromptObj = { ...lastLeveledPrompt };
            leveledCurrent.textContent = currentPromptObj.q;
          } else {
            pickLeveledPrompt();
          }
        } else {
          leveledConfig.style.display = "none";
          flatConfig.style.display = "block";
          if (lastFlatSelection && flatPrompts.includes(lastFlatSelection)) {
            flatSelect.value = lastFlatSelection;
          } else if (flatSelect.options.length) {
            flatSelect.value = flatSelect.options[0].value;
            lastFlatSelection = flatSelect.value;
          } else {
            flatSelect.value = "";
            lastFlatSelection = "";
          }
          if (flatSelect.value) {
            currentPromptObj = { q: flatSelect.value, h: "", source: "flat" };
          }
          updateFlatStarButton();
          refreshFlatPreview();
        }
      });
    });

    indivSecondsInput.addEventListener("input", updateTimeHints);
    groupSecondsInput.addEventListener("input", updateTimeHints);

    catCards.forEach(card => {
      card.addEventListener("click", () => {
        catCards.forEach(c => c.classList.remove("active"));
        card.classList.add("active");
        currentCategory = card.dataset.cat;
        rebuildLeveledDeck();
        pickLeveledPrompt();
      });
    });

    levelCards.forEach(card => {
      card.addEventListener("click", () => {
        levelCards.forEach(c => c.classList.remove("active"));
        card.classList.add("active");
        currentLevel = parseInt(card.dataset.lvl);
        rebuildLeveledDeck();
        pickLeveledPrompt();
      });
    });

    leveledNextBtn.addEventListener("click", () => {
      pickLeveledPrompt();
    });

    flatSelect.addEventListener("change", () => {
      if (flatSelect.value) {
        lastFlatSelection = flatSelect.value;
        if (currentSource === "flat") {
          currentPromptObj = { q: flatSelect.value, h: "", source: "flat" };
        }
      } else {
        lastFlatSelection = "";
      }
      updateFlatStarButton();
      refreshFlatPreview();
    });

    flatRandomBtn.addEventListener("click", () => {
      if (!flatPrompts.length) return;
      const idx = Math.floor(Math.random() * flatPrompts.length);
      const p = flatPrompts[idx];
      flatSelect.value = p;
      lastFlatSelection = p;
      if (currentSource === "flat") {
        currentPromptObj = { q: p, h: "", source: "flat" };
      }
      updateFlatStarButton();
      refreshFlatPreview();
    });

    flatStarBtn.addEventListener("click", () => {
      const p = flatSelect.value;
      if (!p) return;
      if (flatFavorites.includes(p)) {
        flatFavorites = flatFavorites.filter(x => x !== p);
      } else {
        flatFavorites.push(p);
      }
      localStorage.setItem(flatFavKey, JSON.stringify(flatFavorites));
      lastFlatSelection = p;
      renderFlatSelect();
      flatSelect.value = p;
      updateFlatStarButton();
      refreshFlatPreview();
    });

    flatAddBtn.addEventListener("click", () => {
      const val = flatCustom.value.trim();
      if (!val) return;
      if (!flatPrompts.includes(val)) {
        flatPrompts.push(val);
        saveFlatCustom(flatPrompts);
        lastFlatSelection = val;
        renderFlatSelect();
        flatSelect.value = val;
      }
      if (flatSelect.value) {
        lastFlatSelection = flatSelect.value;
        if (currentSource === "flat") {
          currentPromptObj = { q: flatSelect.value, h: "", source: "flat" };
        }
      }
      flatCustom.value = "";
      updateFlatStarButton();
      refreshFlatPreview();
    });

    startActivityBtn.addEventListener("click", () => {
      if (currentSource === "leveled") {
        if (!currentPromptObj) pickLeveledPrompt();
      } else {
        const p = flatSelect.value;
        if (!p) { alert("Pick or add a prompt first."); return; }
        currentPromptObj = { q: p, h: "", source: "flat" };
        lastFlatSelection = p;
      }
      showDisplayView();
      runIndividualPhase();
    });

    advanceBtn.addEventListener("click", () => {
      clearTimer();
      if (currentPhase === "individual") {
        playTone(880,0.25);
        runGroupPhase();
      } else if (currentPhase === "group") {
        playTone(660,0.25);
        runWrapPhase();
      }
    });

    backToSetupBtn.addEventListener("click", () => {
      clearTimer();
      progressBar.style.width = "0%";
      showSetupView();
    });

    copyNotesBtn.addEventListener("click", async () => {
      const txt = wrapNotesEl.value || "";
      const success = await copyTextToClipboard(txt, wrapNotesEl);
      if (success) {
        copyNotesBtn.textContent = "Copied ‚úÖ";
        setTimeout(() => copyNotesBtn.textContent = "Copy notes", 1600);
      } else {
        alert("Could not copy ‚Äî select and copy manually.");
      }
    });

    muteBtn.addEventListener("click", () => {
      muted = !muted;
      muteBtn.textContent = muted ? "üîá" : "üîà";
    });

    // secret modal handlers
    shareCloseBtn.addEventListener("click", closeShareModal);
    shareCopyBtn.addEventListener("click", async () => {
      const text = shareUrlInput.value;
      if (!text) return;
      const success = await copyTextToClipboard(text, shareUrlInput);
      if (success) {
        shareCopyBtn.textContent = "Copied ‚úÖ";
        setTimeout(() => shareCopyBtn.textContent = "Copy", 1400);
      } else {
        alert("Could not copy ‚Äî select and copy manually.");
      }
    });

    // KEY HANDLER: Alt+S to open share
    document.addEventListener("keydown", (e) => {
      if (e.shiftKey && (e.key === "s" || e.key === "S")) {
        e.preventDefault(); 
        openShareModal();
      }
    });

    // click outside to close
    shareBackdrop.addEventListener("click", (e) => {
      if (e.target === shareBackdrop) {
        closeShareModal();
      }
    });

    // ====== INIT ======
    loadFlatPrompts();
    rebuildLeveledDeck();
    pickLeveledPrompt();
    updateTimeHints();
    // load from URL if present
    tryLoadStateFromURL();
  </script>
</body>
</html>
