<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Group Arranger</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <style>
        body { background-color: #f8f9fa; }
        .nav-tabs .nav-link { color: #6c757d; }
        .nav-tabs .nav-link.active { color: #000; font-weight: bold; }
        .group-card {
            background-color: white; border: 1px solid #dee2e6; border-radius: .375rem;
            min-height: 200px; padding: 1rem; margin-bottom: 1.5rem;
            transition: border-color 0.2s ease-in-out; display: flex; flex-direction: column;
        }
        .group-card h5 { border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .student-list { flex-grow: 1; }
        .student-item {
            background-color: #f1f3f5; padding: 0.5rem 0.75rem; border-radius: .25rem;
            margin-bottom: 0.5rem; cursor: grab; user-select: none; border: 1px solid #dee2e6;
        }
        .student-item:active { cursor: grabbing; opacity: 0.8; }
        .student-status { font-size: 0.8em; color: #6c757d; display: block; }
        .dragging { opacity: 0.5; }
        .droppable-valid { border: 2px dashed #198754 !important; background-color: #e9f9f0; }
        .droppable-invalid { border: 2px dashed #dc3545 !important; background-color: #fdeeee; }
        .droppable-neutral { border: 2px dashed #adb5bd; }
    </style>
</head>
<body>

    <div class="container-fluid mt-4">
        <h1 class="mb-4">Student Group Arranger</h1>

        <!-- Bootstrap Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setup-tab-pane" type="button" role="tab" aria-controls="setup-tab-pane" aria-selected="true">1. Setup</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups-tab-pane" type="button" role="tab" aria-controls="groups-tab-pane" aria-selected="false">2. Arrange Groups</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content bg-white p-4 border border-top-0" id="myTabContent">
            <!-- Setup Tab Pane -->
            <div class="tab-pane fade show active" id="setup-tab-pane" role="tabpanel" aria-labelledby="setup-tab" tabindex="0">
                <h3>Import Data</h3>
                <p>Paste data from your Google Sheets. Your work will be saved automatically to this browser.</p>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="requestsData" class="form-label"><strong>Step 1: Paste Requests Data</strong></label>
                            <textarea class="form-control" id="requestsData" rows="10" placeholder="Timestamp	Student Name..."></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="groupingData" class="form-label"><strong>Step 2: Paste Grouping Data</strong></label>
                            <textarea class="form-control" id="groupingData" rows="10" placeholder="Group 1..."></textarea>
                        </div>
                    </div>
                </div>
                <button id="visualizeBtn" class="btn btn-primary">Visualize Groups</button>
            </div>

            <!-- Groups Tab Pane -->
            <div class="tab-pane fade" id="groups-tab-pane" role="tabpanel" aria-labelledby="groups-tab" tabindex="0">
                <h3>Drag and Drop Students</h3>
                <p>Move students between groups to refine the arrangement. Hover over a group title to see survey responses.</p>
                <div id="groups-container" class="row mt-4"></div>
                <hr>
                <div class="mt-3">
                    <button id="exportBtn" class="btn btn-success">Export Grouping for Google Sheets</button>
                    <div id="export-container" class="mt-3" style="display: none;">
                        <label for="exportData" class="form-label"><strong>Copy the text below:</strong></label>
                        <textarea class="form-control" id="exportData" rows="8"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        let studentData = {};
        let popoverList = [];

        function parseRequestsData(text) {
            if (!text) return false;
            studentData = {};
            const rows = text.split('\n');
            const headers = rows[0].split('\t').map(h => h.trim());
            const nameIdx = headers.indexOf('Student Name');
            const wantIdx = headers.indexOf('Would like...');
            const dontWantIdx = headers.indexOf('WOuld not like...');
            const surveyIdx = headers.indexOf('Survey answer');
            
            if (nameIdx === -1 || wantIdx === -1 || dontWantIdx === -1 || surveyIdx === -1) {
                alert("Error: Could not find required headers in requests data.");
                return false;
            }
            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].split('\t');
                const name = rowData[nameIdx]?.trim();
                if (name) {
                    studentData[name] = {
                        name: name,
                        wantWith: rowData[wantIdx] ? rowData[wantIdx].split(',').map(n => n.trim()).filter(Boolean) : [],
                        dontWantWith: rowData[dontWantIdx] ? rowData[dontWantIdx].split(',').map(n => n.trim()).filter(Boolean) : [],
                        surveyAnswer: rowData[surveyIdx]?.trim() || 'N/A'
                    };
                }
            }
            return true;
        }

        function parseGroupingData(text) {
            if (!text) return [];
            let grouping = [];
            const lines = text.split('\n');
            let currentGroup = null;
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.toLowerCase().startsWith('group')) {
                    if (currentGroup) grouping.push(currentGroup);
                    currentGroup = [];
                } else if (currentGroup && trimmedLine) {
                    const parts = trimmedLine.split('\t');
                    const name = parts[1] || parts[2];
                    if (name && name.toLowerCase() !== 'name') {
                       currentGroup.push(name.trim());
                    }
                }
            });
            if (currentGroup) grouping.push(currentGroup);
            return grouping;
        }
        
        function calculateStudentStatus(studentName, groupNames) {
            const data = studentData[studentName];
            if (!data) return { emoji: '❓', text: '(Data not found)' };
            const otherGroupMembers = groupNames.filter(name => name !== studentName);
            const avoidedPartner = data.dontWantWith.find(avoidName => otherGroupMembers.includes(avoidName));
            if (avoidedPartner) return { emoji: '❌', text: `(With ${avoidedPartner})` };
            if (data.wantWith.length > 0) {
                const preferredPartner = data.wantWith.find(wantName => otherGroupMembers.includes(wantName));
                if (preferredPartner) return { emoji: '✅', text: `(With ${preferredPartner})` };
                return { emoji: '⚪', text: `(Unmet: wanted ${data.wantWith.join(', ')})` };
            }
            return { emoji: '—', text: '(No preferences)' };
        }

        function renderGroups(grouping) {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';
            popoverList.forEach(p => p.dispose());
            popoverList = [];

            grouping.forEach((group, index) => {
                const groupCol = document.createElement('div');
                groupCol.className = 'col-lg-3 col-md-4'; // 4 columns on large screens, 3 on medium
                groupCol.innerHTML = `
                    <div class="group-card" id="group-${index}" data-group-index="${index}">
                        <h5 class="group-title">Group ${index + 1}</h5>
                        <div class="student-list"></div>
                    </div>`;
                container.appendChild(groupCol);
                const studentList = groupCol.querySelector('.student-list');
                group.forEach(studentName => {
                    if (studentName) {
                        const studentItem = document.createElement('div');
                        studentItem.className = 'student-item';
                        studentItem.setAttribute('draggable', true);
                        studentItem.dataset.studentName = studentName;
                        studentList.appendChild(studentItem);
                    }
                });
                updateGroupStatuses(groupCol.querySelector('.group-card'));
                initGroupPopover(groupCol.querySelector('.group-card'));
            });
            initDragAndDrop();
        }

        function updateGroupStatuses(groupCard) {
            const groupNames = Array.from(groupCard.querySelectorAll('.student-item')).map(el => el.dataset.studentName);
            groupCard.querySelectorAll('.student-item').forEach(studentEl => {
                const status = calculateStudentStatus(studentEl.dataset.studentName, groupNames);
                studentEl.innerHTML = `${studentEl.dataset.studentName}<span class="student-status">${status.emoji} ${status.text}</span>`;
            });
            updateGroupPopover(groupCard);
        }

        function initGroupPopover(groupCard) {
             const popover = new bootstrap.Popover(groupCard.querySelector('.group-title'), {
                trigger: 'hover', placement: 'top', title: 'Survey Responses', html: true, content: 'Loading...'
            });
            popoverList.push(popover);
            updateGroupPopover(groupCard);
        }

        function updateGroupPopover(groupCard) {
            const popoverInstance = bootstrap.Popover.getInstance(groupCard.querySelector('.group-title'));
            if (!popoverInstance) return;
            const groupNames = Array.from(groupCard.querySelectorAll('.student-item')).map(el => el.dataset.studentName);
            let content = '<ul class="list-unstyled mb-0">';
            if (groupNames.length === 0) content += '<li>Group is empty.</li>';
            else groupNames.forEach(name => content += `<li><strong>${name}:</strong> ${studentData[name]?.surveyAnswer || 'N/A'}</li>`);
            content += '</ul>';
            popoverInstance.setContent({ '.popover-body': content });
        }

        // --- DRAG-AND-DROP LOGIC ---
        function initDragAndDrop() {
            const students = document.querySelectorAll('.student-item');
            const groups = document.querySelectorAll('.group-card');
            let draggedStudent = null, sourceGroup = null;

            students.forEach(student => {
                student.addEventListener('dragstart', (e) => {
                    draggedStudent = student;
                    sourceGroup = student.closest('.group-card');
                    setTimeout(() => student.classList.add('dragging'), 0);
                    
                    const draggedStudentName = draggedStudent.dataset.studentName;
                    const draggedStudentInfo = studentData[draggedStudentName];
                    if (!draggedStudentInfo) return;

                    // *** MODIFIED LOGIC STARTS HERE ***
                    groups.forEach(group => {
                        if (group !== sourceGroup) {
                            const groupStudentNames = Array.from(group.querySelectorAll('.student-item')).map(s => s.dataset.studentName);

                            // CHECK 1: Is the move INVALID (red)?
                            // This is true if the dragged student avoids someone in the group,
                            // OR if someone in the group avoids the dragged student.
                            const isMoveInvalid =
                                draggedStudentInfo.dontWantWith.some(avoid => groupStudentNames.includes(avoid)) ||
                                groupStudentNames.some(existingMember => 
                                    studentData[existingMember]?.dontWantWith.includes(draggedStudentName)
                                );

                            if (isMoveInvalid) {
                                group.classList.add('droppable-invalid');
                                return; // Stop here, invalid takes precedence
                            }

                            // CHECK 2: Is the move POSITIVE (green)?
                            // This is true if the dragged student wants someone in the group,
                            // OR if someone in the group wants the dragged student.
                            const isMovePositive =
                                draggedStudentInfo.wantWith.some(want => groupStudentNames.includes(want)) ||
                                groupStudentNames.some(existingMember => 
                                    studentData[existingMember]?.wantWith.includes(draggedStudentName)
                                );
                            
                            if (isMovePositive) {
                                group.classList.add('droppable-valid');
                            } else {
                                group.classList.add('droppable-neutral');
                            }
                        }
                    });
                     // *** MODIFIED LOGIC ENDS HERE ***
                });

                student.addEventListener('dragend', () => {
                    draggedStudent?.classList.remove('dragging');
                    draggedStudent = null; sourceGroup = null;
                    groups.forEach(group => group.classList.remove('droppable-valid', 'droppable-invalid', 'droppable-neutral'));
                });
            });

            groups.forEach(group => {
                group.addEventListener('dragover', e => e.preventDefault());
                group.addEventListener('drop', e => {
                    e.preventDefault();
                    if (draggedStudent && group !== sourceGroup) {
                        group.querySelector('.student-list').appendChild(draggedStudent);
                        updateGroupStatuses(sourceGroup);
                        updateGroupStatuses(group);
                    }
                });
            });
        }
        
        // --- EXPORT & LOCALSTORAGE ---
        function exportGrouping() {
            let output = '';
            document.querySelectorAll('.group-card').forEach((group, index) => {
                output += `Group ${index + 1}\nStatus\tName\tSurvey Answer\n`;
                group.querySelectorAll('.student-item').forEach(student => {
                    const name = student.dataset.studentName;
                    const statusText = student.querySelector('.student-status').textContent.trim();
                    const survey = studentData[name]?.surveyAnswer || 'N/A';
                    output += `${statusText}\t${name}\t${survey}\n`;
                });
                output += '\n';
            });
            const exportContainer = document.getElementById('export-container');
            const exportTextarea = document.getElementById('exportData');
            exportTextarea.value = output.trim();
            exportContainer.style.display = 'block';
            exportTextarea.select();
            exportTextarea.setSelectionRange(0, 99999);
        }

        function loadFromLocalStorage() {
            document.getElementById('requestsData').value = localStorage.getItem('requestsData') || '';
            document.getElementById('groupingData').value = localStorage.getItem('groupingData') || '';
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', loadFromLocalStorage);

        document.getElementById('requestsData').addEventListener('input', e => localStorage.setItem('requestsData', e.target.value));
        document.getElementById('groupingData').addEventListener('input', e => localStorage.setItem('groupingData', e.target.value));
        
        document.getElementById('visualizeBtn').addEventListener('click', () => {
            try {
                const requestsText = document.getElementById('requestsData').value.trim();
                const groupingText = document.getElementById('groupingData').value.trim();
                if (!requestsText || !groupingText) return alert('Please paste data into both text areas.');
                if (!parseRequestsData(requestsText)) return;
                renderGroups(parseGroupingData(groupingText));
                new bootstrap.Tab(document.getElementById('groups-tab')).show();
            } catch (error) {
                alert("An error occurred. Please check the format of your pasted text.\n\n" + error.message);
                console.error(error);
            }
        });

        document.getElementById('exportBtn').addEventListener('click', exportGrouping);
    </script>

</body>
</html>
