<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaos Sketch: Cyberpunk Classroom</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #121212;
            --text-color: #e0e0e0;
            --neon-pink: #ff0055;
            --neon-cyan: #00f3ff;
            --neon-green: #00ff66;
            --neon-yellow: #ffee00;
            --font-main: 'Arial Black', 'Impact', sans-serif;
            --font-body: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* UTILITIES */
        .hidden {
            display: none !important;
        }

        .invisible {
            opacity: 0;
            pointer-events: none;
        }

        .text-pink {
            color: var(--neon-pink);
        }

        .text-cyan {
            color: var(--neon-cyan);
        }

        .text-green {
            color: var(--neon-green);
        }

        .text-yellow {
            color: var(--neon-yellow);
        }

        button {
            padding: 12px 24px;
            font-family: var(--font-main);
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.6);
            color: var(--neon-cyan);
            border: 2px solid var(--neon-cyan);
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: var(--neon-cyan);
            color: #000;
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        button.primary {
            background: var(--neon-pink);
            border-color: var(--neon-pink);
            color: white;
            font-size: 1.2rem;
        }

        button.primary:hover {
            background: white;
            color: var(--neon-pink);
            box-shadow: 0 0 20px var(--neon-pink);
        }

        button.secondary {
            border-color: #555;
            color: #888;
            font-size: 0.8rem;
            padding: 6px 12px;
        }

        button.secondary:hover {
            border-color: white;
            color: white;
            background: #333;
        }

        /* INPUTS */
        input,
        select,
        textarea {
            background: #1a1a1a;
            color: white;
            border: 1px solid #333;
            padding: 12px;
            font-family: monospace;
            font-size: 1rem;
            width: 100%;
            border-radius: 4px;
        }

        textarea {
            resize: none;
            height: 150px;
        }

        /* --- VIEW: INTRO --- */
        #intro-view {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            padding: 40px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 50;
            overflow-y: auto;
        }

        .intro-container {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 60px;
            max-width: 1000px;
            width: 100%;
            align-items: center;
            margin-bottom: 30px;
        }

        .intro-left {
            text-align: left;
        }

        .title-wrapper {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .neon-bulb {
            width: 80px;
            height: 80px;
            filter: drop-shadow(0 0 10px var(--neon-yellow));
            animation: flicker 4s infinite alternate;
        }

        .bulb-glass {
            fill: none;
            stroke: var(--neon-yellow);
            stroke-width: 3;
        }

        .bulb-filament {
            fill: none;
            stroke: white;
            stroke-width: 2;
        }

        .bulb-base {
            fill: none;
            stroke: #555;
            stroke-width: 3;
        }

        .intro-left h1 {
            font-family: var(--font-main);
            font-size: 5rem;
            line-height: 0.9;
            margin: 0;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        .intro-left p {
            font-size: 1.2rem;
            line-height: 1.6;
            color: #ccc;
            max-width: 550px;
            margin-bottom: 30px;
        }

        .intro-right {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #333;
            padding: 30px;
            border-radius: 12px;
        }

        .steps-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .steps-list li {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            background: var(--neon-cyan);
            color: black;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-family: var(--font-main);
            flex-shrink: 0;
            font-size: 1.1rem;
            margin-top: 3px;
        }

        .step-content {
            display: flex;
            flex-direction: column;
        }

        .step-content strong {
            color: white;
            font-size: 1.1rem;
            font-family: var(--font-main);
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .step-content p {
            color: #888;
            margin: 0;
            line-height: 1.3;
            font-size: 0.95rem;
        }

        .quotes-wrapper {
            width: 100%;
            max-width: 800px;
            height: 80px;
            position: relative;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid #222;
        }

        .quote-slide {
            position: absolute;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            text-align: center;
            width: 100%;
            padding: 0 20px;
        }

        .quote-slide.active {
            opacity: 1;
        }

        .quote-text {
            font-size: 1rem;
            font-style: italic;
            color: #aaa;
            margin-bottom: 8px;
        }

        .quote-author {
            font-family: var(--font-main);
            color: var(--neon-green);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- VIEW: SETUP --- */
        #setup-view {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            z-index: 40;
        }

        .setup-panel {
            background: #0f0f0f;
            border: 1px solid #333;
            padding: 40px;
            width: 100%;
            max-width: 600px;
            border-radius: 8px;
        }

        /* --- VIEW: GAME --- */
        #game-view {
            height: 100%;
            display: grid;
            grid-template-rows: 70px 1fr 100px;
            position: relative;
            z-index: 10;
        }

        #game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            background: #000;
            border-bottom: 1px solid #333;
            z-index: 50;
        }

        #round-info {
            font-family: var(--font-main);
            font-size: 1.2rem;
            color: #666;
        }

        /* TEAM COLUMNS */
        #teams-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            overflow-y: auto;
            background: #050505;
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
        }

        .team-column {
            flex: 1;
            min-width: 300px;
            max-width: 450px;
            border: 1px solid #333;
            background: rgba(30, 30, 30, 0.6);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 1;
            animation: fadeUp 0.5s ease-out;
            transition: all 0.2s;
        }

        .team-header {
            background: #111;
            padding: 15px;
            text-align: center;
            border-bottom: 4px solid var(--neon-pink);
        }

        .team-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--neon-cyan);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .team-score {
            font-family: var(--font-main);
            font-size: 3.5rem;
            color: white;
            line-height: 1;
            margin: 10px 0;
            transition: transform 0.1s;
        }

        .flash-col-green {
            animation: flashGreen 0.5s ease-out;
        }

        .flash-col-red {
            animation: flashRedCol 0.5s ease-out;
        }

        .score-animate {
            animation: scorePop 0.3s ease-out;
        }

        .student-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .student-item {
            padding: 10px;
            margin-bottom: 5px;
            background: #222;
            border-radius: 4px;
            color: #aaa;
            font-size: 1.1rem;
            transition: 0.3s;
            animation: slideIn 0.3s forwards;
        }

        .student-item.drawing {
            background: var(--neon-green);
            color: black;
            font-weight: bold;
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--neon-green);
            border: 2px solid white;
        }

        .student-item.played {
            text-decoration: line-through;
            opacity: 0.3;
            background: #111;
        }

        /* --- FOOTER --- */
        #action-footer {
            background: #0a0a0a;
            border-top: 1px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            z-index: 60;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }

        #main-action-btn {
            width: 100%;
            max-width: 600px;
            font-size: 1.5rem;
            padding: 15px;
            border-radius: 5px;
            letter-spacing: 2px;
        }

        /* --- OVERLAY SYSTEM --- */
        #overlay-layer {
            position: absolute;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 100px;
            pointer-events: none;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.85);
            transition: background 0.3s;
            overflow-y: auto;
            /* ALLOW SCROLL IF CONTENT IS TOO TALL */
        }

        .modal-window {
            background: #000;
            border: 2px solid var(--neon-cyan);
            padding: 30px;
            width: 90%;
            max-width: 1000px;
            text-align: center;
            pointer-events: auto;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            margin: 20px 0;
            /* Add margin for scrolling space */
        }

        /* SUMMON LAYOUT */
        .summon-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            text-align: left;
            margin: 30px 0;
            align-items: stretch;
        }

        .summon-col-left {
            display: flex;
            flex-direction: column;
            gap: 20px;
            justify-content: center;
        }

        .summon-card {
            background: #111;
            padding: 25px;
            border-left: 8px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
        }

        .summon-card.locked {
            border-left-color: var(--neon-green);
            background: #222;
            box-shadow: 0 0 25px rgba(0, 255, 102, 0.2);
            transform: scale(1.02);
        }

        .summon-col-right {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            border-radius: 8px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid #222;
        }

        .check-icon {
            color: var(--neon-cyan);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .check-text {
            color: #ddd;
            font-size: 1.2rem;
        }

        /* SCORING */
        .scoring-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        .scoring-row {
            background: #111;
            padding: 15px 30px;
            border-left: 5px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .scoring-row.flash-row-green {
            background: rgba(0, 255, 102, 0.1);
            border-left-color: var(--neon-green);
        }

        .scoring-row.flash-row-red {
            background: rgba(255, 0, 85, 0.1);
            border-left-color: var(--neon-pink);
        }

        .score-btn-large {
            font-size: 1.5rem;
            width: 50px;
            height: 50px;
            padding: 0;
            margin: 0 10px;
            border-radius: 8px;
        }

        #ready-sequence {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: center;
            margin-top: 50px;
        }

        .ready-dot {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #222;
            border: 4px solid #444;
            transition: all 0.1s;
        }

        .ready-dot.active-red {
            background: #ff0000;
            box-shadow: 0 0 40px #ff0000;
            border-color: white;
        }

        .ready-dot.active-yellow {
            background: #ffee00;
            box-shadow: 0 0 40px #ffee00;
            border-color: white;
        }

        .ready-dot.active-green {
            background: #00ff00;
            box-shadow: 0 0 40px #00ff00;
            border-color: white;
        }

        #ready-text {
            font-family: var(--font-main);
            font-size: 3rem;
            margin-top: 30px;
            min-height: 4rem;
        }

        .lvl-btn {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            border: 2px solid #333;
            color: var(--neon-green);
            background: black;
            margin: 10px;
            cursor: pointer;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
        }

        .lvl-btn h3 {
            margin: 0;
            font-size: 3rem;
            font-family: var(--font-main);
        }

        .lvl-btn span {
            font-size: 0.9rem;
            margin-top: 10px;
            opacity: 0.8;
            font-weight: bold;
            line-height: 1.2;
        }

        .lvl-btn:hover {
            border-color: var(--neon-green);
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--neon-green);
        }

        .lvl-btn.flash-active {
            background: var(--neon-green);
            color: black;
            transform: scale(1.1);
            box-shadow: 0 0 30px var(--neon-green);
            border-color: var(--neon-green);
        }

        /* ACTION STATE - FIXED VERTICAL LAYOUT */
        #state-action {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            height: 100%;
            padding: 20px;
            overflow: hidden;
        }

        /* 1. Prompt Container */
        .draw-prompt-container {
            flex: 7;
            /* Allocate 70% to prompt */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
            overflow: hidden;
        }

        /* 2. Scaled Action Prompt Text */
        #action-prompt {
            font-family: var(--font-body);
            color: var(--neon-yellow);
            line-height: 1.2;
            font-weight: bold;
            text-wrap: balance;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            width: 100%;
            max-width: 1600px;
            text-align: center;
            transition: font-size 0.2s;
            background: rgba(0, 0, 0, 0.6);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #333;
            font-size: 2rem;
        }

        /* Sizing classes applied by JS - using !important */
        .draw-text-huge {
            font-size: clamp(3rem, 7vw, 6rem) !important;
        }

        .draw-text-large {
            font-size: clamp(2.5rem, 5vw, 4.5rem) !important;
        }

        .draw-text-medium {
            font-size: clamp(2rem, 4vw, 3.5rem) !important;
        }

        .draw-text-small {
            font-size: clamp(1.8rem, 3vw, 2.5rem) !important;
        }

        .draw-text-tiny {
            font-size: clamp(1.4rem, 2.5vw, 2rem) !important;
            line-height: 1.4 !important;
        }

        /* 3. Timer Container (Bottom 30%) */
        .draw-timer-container {
            flex: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 20px;
        }

        #timer-huge {
            font-family: var(--font-main);
            font-size: 8rem;
            line-height: 0.9;
            color: white;
            margin-top: -10px;
        }

        #action-text {
            font-family: var(--font-main);
            font-size: 2.5rem;
            color: var(--neon-green);
            margin: 0;
            text-transform: uppercase;
        }

        .timer-warning {
            color: var(--neon-pink) !important;
            animation: blink 0.2s infinite;
        }

        #cap-text {
            font-family: var(--font-main);
            font-size: 4rem;
            color: var(--neon-pink);
            background: black;
            padding: 20px 40px;
            border: 4px solid var(--neon-pink);
        }

        /* PROMPT REVEAL PREVIEW */
        #state-process {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding: 20px;
        }

        #prompt-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-bottom: 20px;
            padding: 0 20px;
            max-height: 50vh;
            /* Ensure there is room for buttons */
            overflow-y: auto;
        }

        #prompt-text {
            font-family: var(--font-body);
            color: white;
            line-height: 1.3;
            text-align: center;
            width: 100%;
            font-weight: bold;
        }

        .text-huge {
            font-size: 4rem;
        }

        .text-medium {
            font-size: 2.8rem;
        }

        .text-compact {
            font-size: 1.8rem;
        }

        .process-controls {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 1px solid #333;
            padding-top: 20px;
            background: #000;
            min-height: 150px;
        }

        /* Teacher Guide */
        #teacher-guide {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .guide-content {
            background: #111;
            padding: 40px;
            max-width: 700px;
            border: 1px solid var(--neon-pink);
            text-align: left;
        }

        .guide-content p {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .guide-content h4 {
            margin-bottom: 5px;
            margin-top: 0;
            letter-spacing: 1px;
        }

        /* TIME'S UP */
        #state-timesup {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000;
            z-index: 200;
            animation: redFlash 0.5s ease-out;
        }

        .timesup-text {
            font-family: var(--font-main);
            font-size: 12rem;
            color: var(--neon-pink);
            margin: 0;
            line-height: 1;
            text-shadow: 0 0 50px var(--neon-pink);
        }

        .timesup-sub {
            font-family: var(--font-main);
            font-size: 4rem;
            color: white;
            margin-top: 20px;
        }

        /* GAME OVER */
        .podium-list {
            text-align: left;
            margin: 30px auto;
            max-width: 600px;
        }

        .podium-item {
            background: #222;
            padding: 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #444;
            font-family: var(--font-main);
        }

        .podium-rank {
            font-size: 2rem;
            margin-right: 20px;
            width: 50px;
        }

        .podium-name {
            font-size: 1.5rem;
            flex: 1;
        }

        .podium-score {
            font-size: 2rem;
            color: white;
        }

        .winner-gold {
            border: 2px solid #ffd700;
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
        }

        .winner-silver {
            border: 2px solid #c0c0c0;
            background: rgba(192, 192, 192, 0.1);
            color: #c0c0c0;
        }

        .winner-bronze {
            border: 2px solid #cd7f32;
            background: rgba(205, 127, 50, 0.1);
            color: #cd7f32;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes slam {
            from {
                transform: scale(3);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes redFlash {
            0% {
                background-color: rgba(255, 0, 0, 0.85);
            }

            100% {
                background-color: #000;
            }
        }

        @keyframes flicker {

            0%,
            19%,
            21%,
            23%,
            25%,
            54%,
            56%,
            100% {
                opacity: 1;
                filter: drop-shadow(0 0 10px var(--neon-yellow));
            }

            20%,
            24%,
            55% {
                opacity: 0.5;
                filter: none;
            }
        }

        @keyframes flashGreen {
            0% {
                background: rgba(0, 255, 102, 0.3);
                border-color: var(--neon-green);
            }

            100% {
                background: rgba(30, 30, 30, 0.6);
                border-color: #333;
            }
        }

        @keyframes flashRedCol {
            0% {
                background: rgba(255, 0, 85, 0.3);
                border-color: var(--neon-pink);
            }

            100% {
                background: rgba(30, 30, 30, 0.6);
                border-color: #333;
            }
        }

        @keyframes scorePop {
            0% {
                transform: scale(1);
                color: white;
            }

            50% {
                transform: scale(1.5);
                color: var(--neon-yellow);
            }

            100% {
                transform: scale(1);
                color: white;
            }
        }
    </style>
</head>

<body>

    <!-- 1. INTRO VIEW -->
    <div id="intro-view">
        <div class="intro-container">
            <div class="intro-left">
                <div class="title-wrapper">
                    <svg class="neon-bulb" viewBox="0 0 24 24">
                        <path class="bulb-base" d="M9 18h6v2H9v-2zm1.5 3h3v1h-3v-1z" />
                        <path class="bulb-glass"
                            d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7z" />
                        <path class="bulb-filament" d="M10 7s1-2 2-2 2 2 2 2" />
                    </svg>
                    <h1>CHAOS<br>SKETCH</h1>
                </div>
                <p><strong>Gamifying Imperfection.</strong><br>Teach rapid iteration and "failing fast" through
                    high-energy, randomized drawing challenges.</p>
                <div style="margin-top: 30px;">
                    <button class="primary" onclick="navTo('setup')">Start Setup</button>
                    <button class="secondary" onclick="toggleGuide(true)" style="margin-left: 10px;">Teacher
                        Guide</button>
                </div>
            </div>
            <div class="intro-right">
                <h3 class="text-cyan" style="margin-top: 0; font-family: var(--font-main);">THE FLOW</h3>
                <ul class="steps-list">
                    <li>
                        <div class="step-icon">1</div>
                        <div class="step-content"><strong>Create Teams.</strong>
                            <p>Paste your roster; the tool handles the rest.</p>
                        </div>
                    </li>
                    <li>
                        <div class="step-icon">2</div>
                        <div class="step-content"><strong>Who Draws?</strong>
                            <p>The system picks one drawer per team.</p>
                        </div>
                    </li>
                    <li>
                        <div class="step-icon">3</div>
                        <div class="step-content"><strong>The Hook.</strong>
                            <p>Drawers get a weird prompt and a random timer.</p>
                        </div>
                    </li>
                    <li>
                        <div class="step-icon">4</div>
                        <div class="step-content"><strong>The Win.</strong>
                            <p>Time runs out. You pick the winner.</p>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="quotes-wrapper">
            <div class="quote-slide active" id="quote-0">
                <div class="quote-text">"This is the least fair game I've ever played. Can we go again?"</div>
                <div class="quote-author">- Alejandro, Grade 6</div>
            </div>
            <div class="quote-slide" id="quote-1">
                <div class="quote-text">"I laughed, I cried. I mostly cried because everyone thought my dog was a
                    potato."</div>
                <div class="quote-author">- Sarah, Grade 8</div>
            </div>
            <div class="quote-slide" id="quote-2">
                <div class="quote-text">"It feels like you're making up the rules as you go, and I respect that."</div>
                <div class="quote-author">- Alex, Grade 7</div>
            </div>
            <div class="quote-slide" id="quote-3">
                <div class="quote-text">"My hands were shaking, but my stick figure was magnificent."</div>
                <div class="quote-author">- Jordan, Grade 9</div>
            </div>
            <div class="quote-slide" id="quote-4">
                <div class="quote-text">"Why is the timer so fast? Who hurt you?"</div>
                <div class="quote-author">- Casey, Grade 10</div>
            </div>
        </div>
    </div>

    <!-- TEACHER GUIDE -->
    <div id="teacher-guide" class="hidden">
        <div class="guide-content">
            <h2 class="text-pink" style="margin-top:0;">TEACHER'S PLAYBOOK</h2>
            <h4 class="text-cyan">1. EMBRACE THE GLITCH</h4>
            <p>This isn't about art; it's about resilience. We are creating a safe space to fail, laugh, and move on.
            </p>
            <h4 class="text-cyan">2. KEEP IT LOOSE</h4>
            <p>Don't let it get serious. If students argue about fairness, remind them the game is rigged on purpose.
            </p>
            <h4 class="text-cyan">3. INTERROGATE THE ART</h4>
            <p>When the timer stops, ask questions. <em>"Where is his other shoe?"</em> Let them explain.</p>
            <h4 class="text-cyan">4. GAME MASTER RULES</h4>
            <p><strong>Hard Rules:</strong> Caps on when waiting. Be kind to teammates. Keep it
                respectful.<br><strong>Soft Rules:</strong> Be arbitrary with points. Award them for "Most Confused
                Dragon" or deduct for "Too Much Realism."</p>
            <button onclick="toggleGuide(false)" style="width: 100%; margin-top: 10px;">CLOSE GUIDE</button>
        </div>
    </div>

    <!-- SETUP -->
    <div id="setup-view" class="hidden">
        <h1 class="text-cyan" style="font-family: var(--font-main);">SESSION SETUP</h1>
        <div class="setup-panel">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <select id="saved-classes" onchange="loadClass()" style="flex: 1;">
                    <option value="">-- Load Class --</option>
                </select>
                <button class="secondary" onclick="saveClass()">Save</button>
                <button class="secondary" onclick="deleteClass()"
                    style="color: var(--neon-pink); border-color: var(--neon-pink);">X</button>
            </div>
            <label style="color:#888; display:block; margin-bottom:5px;">Paste Names (One per line):</label>
            <textarea id="student-names" placeholder="Student A&#10;Student B..."></textarea>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div><label>Teams</label><select id="team-count">
                        <option value="2">2 Teams</option>
                        <option value="3">3 Teams</option>
                        <option value="4">4 Teams</option>
                    </select></div>
                <div><label>Rounds</label><input type="number" id="rounds-input" value="5" min="1"></div>
            </div>
            <button class="primary" onclick="initGame()" style="width: 100%; margin-top: 30px;">GENERATE TEAMS</button>
        </div>
    </div>

    <!-- GAME -->
    <div id="game-view" class="hidden">
        <div id="game-header">
            <div id="round-info">ROUND <span id="round-disp" class="text-pink">1</span> / <span
                    id="round-total">5</span></div>
            <h2 class="text-cyan" style="font-family: var(--font-main); margin:0;">CHAOS SKETCH</h2>
            <button class="secondary" onclick="exitSession()">EXIT</button>
        </div>
        <div id="teams-container"></div>
        <div id="action-footer">
            <button id="main-action-btn" class="primary" onclick="nextPhase('summon')">START SESSION</button>
        </div>

        <div id="overlay-layer" class="hidden">
            <!-- SUMMON -->
            <div id="state-summon" class="modal-window hidden">
                <h2 class="text-yellow" style="font-family:var(--font-main);">DRAWERS SUMMONED</h2>
                <div class="summon-layout">
                    <div class="summon-col-left" id="summon-slots"></div>
                    <!-- RESTORED RIGHT COLUMN -->
                    <div class="summon-col-right">
                        <div class="checklist-item"><span class="check-icon">➤</span><span class="check-text">Walk to
                                the board.</span></div>
                        <div class="checklist-item"><span class="check-icon">➤</span><span class="check-text">Pick up
                                marker (KEEP CAPPED).</span></div>
                        <div class="checklist-item"><span class="check-icon">➤</span><span class="check-text"><strong
                                    class="text-pink">WAIT</strong> for Prompt & Time.</span></div>
                        <div class="checklist-item"><span class="check-icon">➤</span><span class="check-text">Draw fast.
                                Cap when done.</span></div>
                    </div>
                </div>
                <button id="btn-ready" class="primary hidden" onclick="nextPhase('level')" style="width:100%;">WE ARE
                    READY</button>
            </div>
            <!-- LEVEL -->
            <div id="state-level" class="modal-window hidden">
                <h2 class="text-cyan">SELECT CHAOS LEVEL</h2>
                <div style="display:flex; justify-content:center; flex-wrap:wrap;">
                    <div class="lvl-btn" id="btn-1" onclick="setupRound(1)">
                        <h3>1</h3><span>The<br>Perfectionist</span>
                    </div>
                    <div class="lvl-btn" id="btn-2" onclick="setupRound(2)">
                        <h3>2</h3><span>The<br>Surrealist</span>
                    </div>
                    <div class="lvl-btn" id="btn-3" onclick="setupRound(3)">
                        <h3>3</h3><span>The<br>Storyteller</span>
                    </div>
                    <div class="lvl-btn" style="border-color:var(--neon-pink); color:var(--neon-pink);"
                        onclick="randomizeLevel()">
                        <h3>?</h3><span>Randomize</span>
                    </div>
                </div>
            </div>
            <!-- PROCESS -->
            <div id="state-process" class="modal-window hidden">
                <div class="prompt-label">PROMPT:</div>
                <div id="prompt-container">
                    <div id="prompt-text">...</div>
                </div>
                <div class="process-controls">
                    <div id="time-container" class="invisible" style="font-size:1.5rem; margin-bottom:20px;">
                        TIME ALLOTTED: <span id="time-val" class="text-yellow"
                            style="font-size:4rem; font-family:var(--font-main);">0</span> SEC
                    </div>
                    <div id="ready-sequence" class="hidden">
                        <div id="dot-1" class="ready-dot"></div>
                        <div id="dot-2" class="ready-dot"></div>
                        <div id="dot-3" class="ready-dot"></div>
                    </div>
                    <div id="ready-text" class="hidden">READY...</div>
                    <button id="btn-execute" class="primary invisible" onclick="runReadySequence()">INITIATE
                        SEQUENCE</button>
                </div>
            </div>
            <!-- ACTION (SPLIT SCREEN LAYOUT) -->
            <div id="state-action" class="hidden">
                <div class="draw-prompt-container">
                    <div id="action-prompt">PROMPT</div>
                </div>
                <div class="draw-timer-container">
                    <h2 id="action-text">DRAW!</h2>
                    <div id="timer-huge">00</div>
                </div>
                <div id="cap-overlay" class="hidden"
                    style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.9); z-index:999;">
                    <h2 id="cap-text">PENS CAPPED!</h2>
                </div>
            </div>
            <!-- TIMES UP -->
            <div id="state-timesup" class="hidden">
                <h1 class="timesup-text">STOP!</h1>
                <h2 class="timesup-sub">PENS CAPPED!</h2>
            </div>
            <!-- SCORING -->
            <div id="state-scoring" class="modal-window hidden">
                <h2 class="text-pink" style="font-family:var(--font-main);">JUDGMENT TIME</h2>
                <div id="scoring-list" class="scoring-grid"></div>
                <button onclick="finishScoring()" class="primary" style="margin-top:20px;">CONFIRM SCORES</button>
            </div>
            <!-- GAME OVER -->
            <div id="state-gameover" class="modal-window hidden">
                <h1 class="text-cyan" style="font-size: 3rem; margin:0;">MISSION COMPLETE</h1>
                <div id="final-results" class="podium-list"></div>
                <button onclick="exitSession()" class="primary">EXIT TO LOBBY</button>
            </div>
        </div>
    </div>

    <script>
        /* DATA */
        const teamNamesSource = ["The Glitch Goblins", "The Vector Vipers", "The Pixel Punks", "The Render Rebels", "The Syntax Squad"];
        const prompts = {
            1: ["A perfectly symmetrical circle.", "A square with four exactly straight, 90-degree corners.", "An equilateral triangle with three razor-sharp points.", "A perfectly straight horizontal line stretching across the board.", "Two vertical lines that are perfectly parallel like train tracks.", "A 3D cube with perfect perspective lines.", "A symmetrical five-point star.", "A perfectly balanced, smooth heart shape.", "A spiral with perfectly equal spacing between every loop.", "A perfectly smooth, long oval shape.", "A set of stairs with five identical, even steps.", "A perfectly upright stick figure with limbs of equal length.", "A perfectly symmetrical happy face.", "A 3D cylinder (like a soup can) with a perfect circle at the top and bottom.", "A 3D pyramid with a perfectly square base and sharp peak."],
            2: ["A slice of pepperoni pizza wearing sunglasses on a skateboard.", "A cat wearing a high-tech spacesuit floating in a cardboard box.", "A toaster looking very worried about a piece of burnt toast.", "A palm tree with giant robotic arms lifting a heavy barbell.", "A shiny metal robot unhinging its jaw to eat a giant burger.", "A very long-necked giraffe squeezed into a tiny, sudsy bathtub.", "An octopus playing a full drum set with all eight tentacles.", "A sophisticated mushroom wearing a formal tuxedo and a bowtie.", "A penguin wearing a tutu trying to hula-hoop with a giant donut.", "A broken pencil in a sword fight with a metal pencil sharpener.", "A high-top sneaker with four massive monster truck wheels.", "A transparent ghost eating a very messy, dripping taco.", "A glowing lightbulb that has a visible human brain inside it.", "A vintage television walking on long, robotic mechanical legs.", "A prickly cactus holding a bunch of heart-shaped balloons."],
            3: ["An alligator is hanging ten on a surfboard while frantically taking a selfie. His friend is in the background looking annoyed because they are late for a party. One of them is wearing a party hat.", "A billionaire squirrel wearing a tiny top hat is signing a peace treaty with a pigeon. He is sitting on a throne made entirely of shiny, golden acorns while holding a tiny pen.", "A Victorian-era ghost is staring intensely at a microwave, trying to figure out how to heat his tea. He looks frustrated because his ghostly hand keeps passing through the 'Start' button.", "A group of angry broccoli stalks are holding tiny protest signs outside a steakhouse. One of them is wearing a yellow raincoat because it’s starting to drizzle ranch dressing from the sky.", "A massive, scaly dragon is sitting on the floor trying to fold a fitted sheet and failing miserably. He is upset because his hoard of gold was replaced by chocolate coins that are starting to melt.", "A detective bloodhound wearing a trench coat is using a magnifying glass to inspect a crime scene. A giant jelly donut has been stolen, and there are sprinkles leading toward a mouse hole.", "A giant, sentient mountain with a face is having a deep conversation with a passing cloud. A tiny hiker is accidentally tickling the mountain’s snowy nose with a walking stick.", "A time-traveling toaster has appeared in the middle of a jungle and is trying to offer a piece of toast to a confused T-Rex. The T-Rex is wearing a giant bib and looks ready to eat the toaster.", "A weary office-worker squid is trying to type an urgent email using all eight tentacles at once. His boss, a very judgmental goldfish in a bowl, is watching his every move from the desk.", "A garden gnome is standing on a podium made of a single mushroom, giving a campaign speech for President. A squirrel is filming the whole thing on a tiny smartphone while wearing a 'Press' badge.", "A grumpy pineapple pirate with a wooden toothpick for a leg is standing on the deck of a ship. His crew is made of grapes, and they are currently being chased by a giant, hungry kitchen blender.", "A high-stakes poker game is happening between a turtle, a rabbit, and a sloth. The 'pot' in the middle of the table is one single, perfect strawberry that they are all staring at intensely.", "A sophisticated polar bear wearing a monocle is sitting at a bus stop in the middle of a scorching hot desert. He is holding a melting ice cream cone and looking at a map of the North Pole.", "An alien family is trying to build a piece of Swedish furniture, but the instructions are written in a language only their pet space-slug understands. The dad is holding a weird glowing wrench.", "A fancy gala for bugs is happening on a leaf, and a fly is mortified because he’s wearing the same tuxedo as a ladybug. A spider waiter is awkwardly offering them tiny glasses of juice."]
        };

        let audioCtx;
        let gameState = { teams: [], currentRound: 1, totalRounds: 5, activeDrawers: [], currentTime: 0, currentPrompt: "" };

        /* INIT */
        document.addEventListener('DOMContentLoaded', () => { loadSavedKeys(); initQuotes(); });
        function initQuotes() {
            const slides = document.querySelectorAll('.quote-slide'); let current = 0;
            setInterval(() => { slides[current].classList.remove('active'); current = (current + 1) % slides.length; slides[current].classList.add('active'); }, 4000);
        }

        /* AUDIO */
        function playSound(type) {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.connect(g); g.connect(audioCtx.destination);
                const t = audioCtx.currentTime;
                if (type === 'tick') { osc.frequency.setValueAtTime(800, t); g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.05); osc.start(t); osc.stop(t + 0.05); }
                else if (type === 'lock') { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(800, t + 0.1); g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.3); osc.start(t); osc.stop(t + 0.3); }
                else if (type === 'ready') { osc.frequency.setValueAtTime(600, t); g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.2); osc.start(t); osc.stop(t + 0.2); }
                else if (type === 'go') { osc.frequency.setValueAtTime(1200, t); g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.4); osc.start(t); osc.stop(t + 0.4); }
                else if (type === 'buzzer') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(50, t + 0.5); g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.5); osc.start(t); osc.stop(t + 0.5); }
                else if (type === 'score') { osc.type = 'sine'; osc.frequency.setValueAtTime(880, t); osc.frequency.exponentialRampToValueAtTime(1760, t + 0.1); g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.4); osc.start(t); osc.stop(t + 0.4); }
                else if (type === 'loss') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(50, t + 0.3); g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.3); osc.start(t); osc.stop(t + 0.3); }
            } catch (e) { console.log("Audio blocked"); }
        }

        /* NAV */
        function toggleGuide(show) { document.getElementById('teacher-guide').classList.toggle('hidden', !show); }
        function navTo(id) {
            ['intro-view', 'setup-view', 'game-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id + '-view').classList.remove('hidden');
        }
        function exitSession() {
            if (confirm("End session?")) {
                navTo('intro');
                document.getElementById('overlay-layer').classList.add('hidden');
                gameState = { teams: [], currentRound: 1, totalRounds: 5, activeDrawers: [], currentTime: 0, currentPrompt: "" };
                document.getElementById('teams-container').innerHTML = '';
                document.getElementById('main-action-btn').innerText = "START SESSION";
                document.getElementById('main-action-btn').classList.remove('hidden');
            }
        }

        /* SETUP */
        function initGame() {
            const raw = document.getElementById('student-names').value.trim();
            const names = raw.split('\n').map(n => n.trim()).filter(n => n);
            if (names.length < 2) { alert("Need at least 2 names."); return; }
            const teamCount = parseInt(document.getElementById('team-count').value);
            gameState.totalRounds = parseInt(document.getElementById('rounds-input').value);
            gameState.currentRound = 1;
            gameState.teams = [];
            const sNames = names.sort(() => Math.random() - 0.5);
            const sTeams = teamNamesSource.sort(() => Math.random() - 0.5);
            for (let i = 0; i < teamCount; i++) {
                gameState.teams.push({ id: i, name: sTeams[i] || `Team ${i + 1}`, score: 0, roster: [] });
            }
            sNames.forEach((n, i) => gameState.teams[i % teamCount].roster.push({ name: n, played: false, uid: `p-${i}` }));
            renderBoard();
            navTo('game');
            document.getElementById('overlay-layer').classList.add('hidden');
        }

        function renderBoard() {
            const container = document.getElementById('teams-container');
            container.innerHTML = '';
            gameState.teams.forEach((t, tIndex) => {
                let list = t.roster.map((s, sIndex) => `<div id="${s.uid}" class="student-item ${s.played ? 'played' : ''}" style="animation-delay: ${tIndex * 0.2 + sIndex * 0.05}s">${s.name}</div>`).join('');
                container.innerHTML += `<div id="col-${t.id}" class="team-column" style="animation-delay:${tIndex * 0.1}s"><div class="team-header"><div class="team-name">${t.name}</div><div style="display:flex; justify-content:center; gap:10px; align-items:center;"><button class="secondary" onclick="modScore(${t.id}, -1)">-</button><div class="team-score" id="score-${t.id}">${t.score}</div><button class="secondary" onclick="modScore(${t.id}, 1)">+</button></div></div><div class="student-list">${list}</div></div>`;
            });
            document.getElementById('round-disp').innerText = gameState.currentRound;
            document.getElementById('round-total').innerText = gameState.totalRounds;
        }

        function modScore(tid, val) {
            const t = gameState.teams.find(x => x.id === tid);
            t.score += val;
            const scoreEl = document.getElementById(`score-${tid}`); if (scoreEl) scoreEl.innerText = t.score;
            const modalScoreEl = document.getElementById(`modal-score-${tid}`); if (modalScoreEl) modalScoreEl.innerText = t.score;
            const colEl = document.getElementById(`col-${tid}`);
            const modalRowEl = document.getElementById(`modal-row-${tid}`);
            if (val > 0) {
                playSound('score');
                if (colEl) { colEl.classList.remove('flash-col-green', 'flash-col-red'); void colEl.offsetWidth; colEl.classList.add('flash-col-green'); }
                if (modalRowEl) { modalRowEl.classList.remove('flash-row-green', 'flash-row-red'); void modalRowEl.offsetWidth; modalRowEl.classList.add('flash-row-green'); }
            } else {
                playSound('loss');
                if (colEl) { colEl.classList.remove('flash-col-green', 'flash-col-red'); void colEl.offsetWidth; colEl.classList.add('flash-col-red'); }
                if (modalRowEl) { modalRowEl.classList.remove('flash-row-green', 'flash-row-red'); void modalRowEl.offsetWidth; modalRowEl.classList.add('flash-row-red'); }
            }
        }

        /* STATES */
        function showOverlay(id) {
            const layer = document.getElementById('overlay-layer');
            layer.classList.remove('hidden');
            layer.style.background = 'rgba(0,0,0,0.85)';
            Array.from(layer.children).forEach(c => c.classList.add('hidden'));
            if (id) document.getElementById(id).classList.remove('hidden'); else layer.classList.add('hidden');
        }

        function nextPhase(phase) {
            if (phase === 'summon') {
                if (gameState.currentRound > gameState.totalRounds) { endGame(); return; }
                document.getElementById('main-action-btn').classList.add('hidden');
                setupSummonUI(); showOverlay('state-summon'); runSlotMachine();
            } else if (phase === 'level') {
                document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('flash-active'));
                showOverlay('state-level');
            }
        }

        function setupSummonUI() {
            const container = document.getElementById('summon-slots'); container.innerHTML = '';
            gameState.activeDrawers = [];
            document.getElementById('btn-ready').classList.add('hidden');
            gameState.teams.forEach(t => {
                let unplayed = t.roster.filter(x => !x.played);
                if (unplayed.length === 0) { t.roster.forEach(x => x.played = false); renderBoard(); unplayed = t.roster; }
                let target = unplayed[Math.floor(Math.random() * unplayed.length)];
                gameState.activeDrawers.push({ t: t, s: target });
                const div = document.createElement('div'); div.className = 'summon-card'; div.id = `slot-card-${t.id}`;
                div.innerHTML = `<span style="color:#888;">${t.name}</span><span class="slot-name" style="font-size:1.5rem; font-weight:bold; color:white;">...</span>`;
                container.appendChild(div);
            });
        }

        function runSlotMachine() {
            const iterations = 15; const speed = 100;
            gameState.teams.forEach((t, index) => {
                const card = document.getElementById(`slot-card-${t.id}`);
                const nameEl = card.querySelector('.slot-name');
                const targetName = gameState.activeDrawers[index].s.name;
                const pool = t.roster.map(r => r.name);
                let count = 0;
                setTimeout(() => {
                    const interval = setInterval(() => {
                        nameEl.innerText = pool[Math.floor(Math.random() * pool.length)];
                        playSound('tick'); count++;
                        if (count > iterations) {
                            clearInterval(interval); nameEl.innerText = targetName;
                            card.classList.add('locked'); playSound('lock');
                            const domEl = document.getElementById(gameState.activeDrawers[index].s.uid);
                            if (domEl) domEl.classList.add('drawing');
                            if (index === gameState.teams.length - 1) setTimeout(() => document.getElementById('btn-ready').classList.remove('hidden'), 500);
                        }
                    }, speed);
                }, index * 600);
            });
        }

        function randomizeLevel() {
            let count = 0; const max = 10;
            const interval = setInterval(() => {
                [1, 2, 3].forEach(n => document.getElementById('btn-' + n).classList.remove('flash-active'));
                const r = Math.floor(Math.random() * 3) + 1;
                document.getElementById('btn-' + r).classList.add('flash-active'); playSound('tick'); count++;
                if (count > max) { clearInterval(interval); playSound('lock'); setTimeout(() => setupRound(r), 600); }
            }, 150);
        }

        function setupRound(lvl) {
            let min = lvl === 1 ? 2 : lvl === 2 ? 6 : 10;
            let max = lvl === 1 ? 4 : lvl === 2 ? 10 : 15;
            gameState.currentTime = Math.floor(Math.random() * (max - min + 1) + min);
            const pList = prompts[lvl];
            gameState.currentPrompt = pList[Math.floor(Math.random() * pList.length)];

            // AUTO SIZE TEXT LOGIC - APPLIED TO PREVIEW SCREEN
            const textEl = document.getElementById('prompt-text');
            textEl.innerText = gameState.currentPrompt;
            textEl.classList.remove('text-huge', 'text-medium', 'text-compact');
            const len = gameState.currentPrompt.length;
            if (len < 50) textEl.classList.add('text-huge');
            else if (len < 120) textEl.classList.add('text-medium');
            else textEl.classList.add('text-compact');

            // Apply same logic to Action Prompt
            const actEl = document.getElementById('action-prompt');
            actEl.innerText = gameState.currentPrompt;
            actEl.classList.remove('draw-text-huge', 'draw-text-large', 'draw-text-medium', 'draw-text-small', 'draw-text-tiny');

            // NEW GRANULAR SIZING
            if (len < 50) actEl.classList.add('draw-text-huge');
            else if (len < 100) actEl.classList.add('draw-text-large');
            else if (len < 150) actEl.classList.add('draw-text-medium');
            else if (len < 220) actEl.classList.add('draw-text-small');
            else actEl.classList.add('draw-text-tiny');

            document.getElementById('time-container').classList.add('invisible');
            document.getElementById('btn-execute').classList.add('invisible');
            document.getElementById('time-val').innerText = gameState.currentTime;
            document.getElementById('ready-sequence').classList.add('hidden');
            document.getElementById('ready-text').classList.add('hidden');
            document.querySelectorAll('.ready-dot').forEach(d => d.className = 'ready-dot');

            showOverlay('state-process');
            setTimeout(() => {
                const timeDiv = document.getElementById('time-container');
                timeDiv.classList.remove('invisible'); timeDiv.classList.add('slam-in');
                playSound('lock');
                setTimeout(() => document.getElementById('btn-execute').classList.remove('invisible'), 500);
            }, 3000);
        }

        function runReadySequence() {
            document.getElementById('btn-execute').classList.add('hidden');
            document.getElementById('ready-sequence').classList.remove('hidden');
            document.getElementById('ready-text').classList.remove('hidden');
            const d1 = document.getElementById('dot-1'); const d2 = document.getElementById('dot-2'); const d3 = document.getElementById('dot-3'); const txt = document.getElementById('ready-text');
            d1.classList.add('active-red'); txt.innerText = "READY..."; playSound('ready');
            setTimeout(() => {
                d2.classList.add('active-yellow'); txt.innerText = "SET..."; playSound('ready');
                setTimeout(() => {
                    d3.classList.add('active-green'); txt.innerText = "DRAW!"; txt.style.color = "#00ff00"; playSound('go');
                    setTimeout(startTimer, 800);
                }, 1000);
            }, 1000);
        }

        function startTimer() {
            showOverlay('state-action');
            document.getElementById('timer-huge').innerText = gameState.currentTime;

            // Ensure button hidden/visible logic
            document.getElementById('btn-execute').classList.remove('hidden');

            let t = gameState.currentTime;
            const int = setInterval(() => {
                t--;
                document.getElementById('timer-huge').innerText = t;
                if (t <= 3) document.getElementById('timer-huge').classList.add('timer-warning');
                if (t <= 0) {
                    clearInterval(int);
                    playSound('buzzer');
                    // CLEAN SWITCH TO "TIMES UP" STATE
                    document.getElementById('state-action').classList.add('hidden');
                    document.getElementById('state-timesup').classList.remove('hidden');
                    setTimeout(endTurn, 2500);
                }
            }, 1000);
        }

        function endTurn() {
            gameState.activeDrawers.forEach(o => {
                o.s.played = true;
                const el = document.getElementById(o.s.uid);
                if (el) { el.classList.remove('drawing'); el.classList.add('played'); }
            });

            // Show Scoring
            const container = document.getElementById('scoring-list'); container.innerHTML = '';
            gameState.teams.forEach(t => {
                container.innerHTML += `
            <div id="modal-row-${t.id}" class="scoring-row">
                <span class="team-name" style="font-size:1.2rem;">${t.name}</span>
                <div style="display:flex; align-items:center;">
                    <button class="secondary score-btn-large" onclick="modScore(${t.id}, -1)">-</button>
                    <span id="modal-score-${t.id}" class="team-score" style="margin:0 20px;">${t.score}</span>
                    <button class="secondary score-btn-large" onclick="modScore(${t.id}, 1)">+</button>
                </div>
            </div>`;
            });
            showOverlay('state-scoring');
        }

        function finishScoring() {
            gameState.currentRound++;
            document.getElementById('round-disp').innerText = gameState.currentRound;
            showOverlay(null);
            const btn = document.getElementById('main-action-btn');
            btn.innerText = "NEXT ROUND";
            btn.classList.remove('hidden');
            // Reset states
            document.getElementById('ready-text').style.color = "white";
            document.getElementById('btn-execute').classList.remove('hidden');
            document.getElementById('state-timesup').classList.add('hidden');
            document.getElementById('state-action').classList.remove('hidden');
            document.getElementById('timer-huge').classList.remove('timer-warning');
            document.getElementById('cap-overlay').classList.add('hidden');
        }

        function endGame() {
            showOverlay('state-gameover');
            let html = '';
            [...gameState.teams].sort((a, b) => b.score - a.score).forEach((t, i) => {
                let rankClass = i === 0 ? 'winner-gold' : i === 1 ? 'winner-silver' : i === 2 ? 'winner-bronze' : '';
                html += `<div class="podium-item ${rankClass}"><div class="podium-rank">#${i + 1}</div><div class="podium-name">${t.name}</div><div class="podium-score">${t.score} PTS</div></div>`;
            });
            document.getElementById('final-results').innerHTML = html;
        }

        /* SAVE */
        function loadSavedKeys() { try { const sel = document.getElementById('saved-classes'); if (sel) { sel.innerHTML = '<option value="">-- Load Class --</option>'; Object.keys(JSON.parse(localStorage.getItem('chaosClasses') || '{}')).forEach(k => sel.innerHTML += `<option value="${k}">${k}</option>`); } } catch (e) { } }
        function saveClass() { try { const n = prompt("Class Name:"); if (n) { const d = JSON.parse(localStorage.getItem('chaosClasses') || '{}'); d[n] = document.getElementById('student-names').value; localStorage.setItem('chaosClasses', JSON.stringify(d)); loadSavedKeys(); } } catch (e) { } }
        function loadClass() { try { const k = document.getElementById('saved-classes').value; if (k) document.getElementById('student-names').value = JSON.parse(localStorage.getItem('chaosClasses') || '{}')[k]; } catch (e) { } }
        function deleteClass() { try { const k = document.getElementById('saved-classes').value; if (k && confirm("Delete?")) { const d = JSON.parse(localStorage.getItem('chaosClasses') || '{}'); delete d[k]; localStorage.setItem('chaosClasses', JSON.stringify(d)); loadSavedKeys(); document.getElementById('student-names').value = ""; } } catch (e) { } }
    </script>
</body>

</html>